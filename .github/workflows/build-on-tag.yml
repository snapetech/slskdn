name: Build on Tag

# Trigger: push tag matching build-dev-* or build-main-*
# 
# Dev builds:   build-dev-0.24.1.dev.20251213.203634
#               â†’ Creates release under same tag
# 
# Main builds:  build-main-0.24.1-slskdn.35 (trigger)
#               â†’ Creates release under 0.24.1-slskdn.35 (backward compatible)
#
# Examples:
#   git tag build-dev-0.24.1.dev.$(date -u +%Y%m%d.%H%M%S) && git push origin $_
#   git tag build-main-0.24.1-slskdn.35 && git push origin $_

on:
  push:
    tags:
      - 'build-dev-*'
      - 'build-main-*'
  workflow_dispatch:

env:
  DOTNET_VERSION: '8'

jobs:
  parse:
    name: Parse Tag
    runs-on: ubuntu-latest
    outputs:
      channel: ${{ steps.parse.outputs.channel }}
      version: ${{ steps.parse.outputs.version }}
    steps:
      - name: Parse Tag
        id: parse
        run: |
          TAG="${{ github.ref_name }}"
          echo "Tag: $TAG"
          
          # Extract channel and version from tag
          # Format: build-<channel>-<version>
          if [[ "$TAG" =~ ^build-(dev|main)-(.+)$ ]]; then
            CHANNEL="${BASH_REMATCH[1]}"
            VERSION="${BASH_REMATCH[2]}"
          else
            echo "::error::Invalid tag format. Expected: build-<channel>-<version>"
            exit 1
          fi
          
          echo "Channel: $CHANNEL"
          echo "Version: $VERSION"
          
          echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  build:
    name: Build
    needs: parse
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/web/package-lock.json

      - name: Build Frontend
        working-directory: src/web
        run: |
          npm ci
          DISABLE_ESLINT_PLUGIN=true npm run build

      - name: Upload Web Content
        uses: actions/upload-artifact@v4
        with:
          name: web-content
          path: src/web/build
          retention-days: 7

  publish:
    name: Publish ${{ matrix.runtime }}
    needs: [parse, build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        runtime:
          - linux-x64
          - linux-musl-x64
          - linux-arm64
          - osx-x64
          - osx-arm64
          - win-x64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Download Web Content
        uses: actions/download-artifact@v4
        with:
          name: web-content
          path: src/slskd/wwwroot

      - name: Build ${{ matrix.runtime }}
        run: |
          # Convert version back to hyphen format for .NET
          # Dots are for package managers, hyphens for NuGet
          DOTNET_VERSION=$(echo "${{ needs.parse.outputs.version }}" | sed 's/\.dev\./-dev-/')
          echo "Building with version: $DOTNET_VERSION"
          
          dotnet publish src/slskd/slskd.csproj \
            -c Release \
            -o publish-${{ matrix.runtime }} \
            --self-contained true \
            -r ${{ matrix.runtime }} \
            /p:Version="$DOTNET_VERSION"

      - name: Create Archive
        run: |
          cd publish-${{ matrix.runtime }}
          zip -r ../slskdn-${{ needs.parse.outputs.channel }}-${{ matrix.runtime }}.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: slskdn-${{ needs.parse.outputs.channel }}-${{ matrix.runtime }}
          path: slskdn-${{ needs.parse.outputs.channel }}-${{ matrix.runtime }}.zip
          retention-days: 30

  release-dev:
    name: Create Dev Release
    needs: [parse, publish]
    if: needs.parse.outputs.channel == 'dev'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: slskdn-dev-*

      - name: Prepare Release Assets
        run: |
          mkdir -p release
          find artifacts -name "*.zip" -exec cp {} release/ \;
          ls -lh release/

      - name: Create/Update Dev Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "ðŸ§ª Dev Build ${{ needs.parse.outputs.version }}"
          body: |
            ## Development Build ${{ needs.parse.outputs.version }}
            
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            
            ### âš ï¸ Experimental Features
            - ðŸ”’ Enhanced security (Ed25519 identity, TLS pinning, signed descriptors)
            - ðŸ”€ Multi-source swarm downloads
            - ðŸŒ DHT mesh network
            - ðŸ”— BitTorrent DHT rendezvous
            
            ### Installation
            **Package Managers:**
            - Arch: `yay -S slskdn-dev`
            - Fedora/RHEL: `sudo dnf copr enable slskdn/slskdn-dev && sudo dnf install slskdn-dev`
            - Ubuntu/Debian: `sudo add-apt-repository ppa:keefshape/slskdn && sudo apt install slskdn-dev`
            - Docker: `docker pull ghcr.io/snapetech/slskdn:dev`
            
            **Direct Download:** Extract the archive for your platform and run the binary.
          prerelease: true
          files: release/*

      - name: Trigger Package Workflows
        if: success()
        run: |
          echo "âœ… Dev release created: ${{ github.ref_name }}"
          echo "ðŸ“¦ Triggering AUR/COPR/Docker builds..."
          
          # Trigger the old dev-release workflow which has all the packaging
          gh workflow run dev-release.yml || echo "dev-release.yml trigger failed (expected if disabled)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  aur-dev:
    name: Publish to AUR (Dev)
    needs: [parse, release-dev]
    if: needs.parse.outputs.channel == 'dev'
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.info.outputs.short_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get commit info
        id: info
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Download from Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Download from the release we just created
          gh release download "${{ github.ref_name }}" \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-linux-x64.zip"

      - name: Setup SSH for AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then
            echo "âš ï¸ AUR_SSH_KEY not configured, skipping AUR publish"
            exit 0
          fi
          
          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          
          cat >> ~/.ssh/config << EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
          EOF
          
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts

      - name: Clone AUR Package
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then exit 0; fi
          
          git clone ssh://aur@aur.archlinux.org/slskdn-dev.git aur-pkg || {
            mkdir -p aur-pkg
            cd aur-pkg
            git init
            git remote add origin ssh://aur@aur.archlinux.org/slskdn-dev.git
          }

      - name: Update PKGBUILD
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then exit 0; fi
          
          cd aur-pkg
          
          # Copy the dev PKGBUILD template
          cp ../packaging/aur/PKGBUILD-dev PKGBUILD
          cp ../packaging/aur/slskd.install slskd.install
          
          # Convert version for Arch (replace ALL hyphens with dots)
          ARCH_VERSION=$(echo "${{ needs.parse.outputs.version }}" | sed 's/-/./g')
          
          # Update version and commit
          sed -i "s/^pkgver=.*/pkgver=${ARCH_VERSION}/" PKGBUILD
          sed -i "s/^_commit=.*/_commit=${{ steps.info.outputs.short_sha }}/" PKGBUILD
          
          # Generate .SRCINFO
          docker run --rm -v "$PWD:/pkg" -w /pkg archlinux:base-devel bash -c "
            pacman -Sy --noconfirm pacman-contrib
            useradd -m builder
            chown -R builder:builder /pkg
            su builder -c 'makepkg --printsrcinfo' > .SRCINFO
          "
          
          sudo chown -R $(id -u):$(id -g) .
          
          echo "ðŸ“ Updated PKGBUILD:"
          cat PKGBUILD | head -30

      - name: Push to AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then
            echo "âš ï¸ Skipping AUR push - credentials not configured"
            exit 0
          fi
          
          cd aur-pkg
          git config user.name "slskdn CI"
          git config user.email "slskdn@proton.me"
          git add PKGBUILD .SRCINFO slskd.install
          git commit -m "Update to ${{ needs.parse.outputs.version }}" || echo "No changes"
          git push origin master || git push --set-upstream origin master
          
          echo "âœ… Pushed to AUR: slskdn-dev"

  copr-dev:
    name: Publish to COPR (Dev)
    needs: [parse, release-dev]
    if: needs.parse.outputs.channel == 'dev'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download from Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ github.ref_name }}" \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-linux-x64.zip"

      - name: Setup RPM Build
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip rpm
          pip3 install copr-cli
          mkdir -p ~/rpmbuild/{SOURCES,SPECS,SRPMS}

      - name: Prepare Sources
        run: |
          # Copy the built zip to SOURCES
          cp slskdn-dev-linux-x64.zip ~/rpmbuild/SOURCES/
          
          # Copy supporting files
          cp packaging/aur/slskd.service ~/rpmbuild/SOURCES/
          cp packaging/aur/slskd.yml ~/rpmbuild/SOURCES/
          cp packaging/aur/slskd.sysusers ~/rpmbuild/SOURCES/slskd.conf

      - name: Update Spec File
        run: |
          # Use the dev spec template
          cp packaging/rpm/slskdn-dev.spec ~/rpmbuild/SPECS/
          
          # Convert version for RPM (replace ALL hyphens with dots)
          # 0.24.1-dev-20251209-203936 â†’ 0.24.1.dev.20251209.203936
          RPM_VERSION=$(echo "${{ needs.parse.outputs.version }}" | sed 's/-/./g')
          
          # Update version
          sed -i "s/^Version:.*/Version:        ${RPM_VERSION}/" ~/rpmbuild/SPECS/slskdn-dev.spec
          
          cat ~/rpmbuild/SPECS/slskdn-dev.spec | head -30

      - name: Configure COPR
        env:
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
        run: |
          if [ -z "$COPR_LOGIN" ] || [ -z "$COPR_TOKEN" ]; then
            echo "COPR credentials not configured. Skipping."
            exit 0
          fi
          mkdir -p ~/.config
          cat > ~/.config/copr << EOF
          [copr-cli]
          login = ${COPR_LOGIN}
          username = slskdn
          token = ${COPR_TOKEN}
          copr_url = https://copr.fedorainfracloud.org
          EOF

      - name: Build SRPM
        run: |
          rpmbuild -bs ~/rpmbuild/SPECS/slskdn-dev.spec --define "_topdir $HOME/rpmbuild"
          
          SRPM=$(find ~/rpmbuild/SRPMS -name "*.src.rpm" | head -1)
          echo "Built SRPM: $SRPM"
          rpm -qpl "$SRPM" | head -20
          echo "SRPM_PATH=$SRPM" >> $GITHUB_ENV

      - name: Upload to COPR
        env:
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
        run: |
          if [ -z "$COPR_LOGIN" ] || [ -z "$COPR_TOKEN" ]; then
            echo "Skipping COPR upload - credentials not configured"
            exit 0
          fi
          
          echo "Uploading SRPM to COPR: $SRPM_PATH"
          # Upload to slskdn-dev project (separate from stable)
          copr-cli build slskdn/slskdn-dev "$SRPM_PATH" --nowait
          echo "âœ… Uploaded to COPR: slskdn-dev"

  ppa-dev:
    name: Publish to PPA (Dev)
    needs: [parse, release-dev]
    if: needs.parse.outputs.channel == 'dev'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download from Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ github.ref_name }}" \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-linux-x64.zip"
          unzip slskdn-dev-linux-x64.zip -d publish-linux-x64

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dput gnupg build-essential

      - name: Import GPG Key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "GPG_PRIVATE_KEY secret not set. Skipping PPA upload."
            exit 0
          fi
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          # Trust the key
          KEY_ID=$(gpg --list-keys --keyid-format long | grep -A1 "^pub" | tail -1 | awk '{print $1}')
          echo "$KEY_ID:6:" | gpg --import-ownertrust

      - name: Prepare Source Structure
        run: |
          VERSION="${{ needs.parse.outputs.version }}"
          
          # Create proper directory structure for debian packaging
          mkdir -p slskdn-dev-${VERSION}/usr/lib/slskd
          mkdir -p slskdn-dev-${VERSION}/lib/systemd/system
          mkdir -p slskdn-dev-${VERSION}/etc/slskd
          mkdir -p slskdn-dev-${VERSION}/usr/lib/sysusers.d
          
          # Copy binary files from our build
          cp -r publish-linux-x64/* slskdn-dev-${VERSION}/usr/lib/slskd/
          
          # Copy service files from packaging
          cp packaging/aur/slskd.service slskdn-dev-${VERSION}/lib/systemd/system/
          cp packaging/aur/slskd.yml slskdn-dev-${VERSION}/etc/slskd/
          cp packaging/aur/slskd.sysusers slskdn-dev-${VERSION}/usr/lib/sysusers.d/slskd.conf

      - name: Prepare Source Package
        run: |
          VERSION="${{ needs.parse.outputs.version }}"
          # Convert version for Debian (replace ALL hyphens with dots)
          DEB_VERSION=$(echo "$VERSION" | sed 's/-/./g')
          
          # Create tarball for orig source
          tar -czvf slskdn-dev_${DEB_VERSION}.orig.tar.gz slskdn-dev-${VERSION}
          
          # Copy and modify debian directory for -dev package
          cp -r packaging/debian slskdn-dev-${VERSION}/
          
          # Update control file for slskdn-dev package
          cd slskdn-dev-${VERSION}
          sed -i 's/^Source: slskdn$/Source: slskdn-dev/' debian/control
          sed -i 's/^Package: slskdn$/Package: slskdn-dev/' debian/control
          sed -i 's/^Conflicts: slskd$/Conflicts: slskd, slskdn/' debian/control
          sed -i 's/^Replaces: slskd$/Replaces: slskd, slskdn/' debian/control
          sed -i 's/^Description:.*/Description: ðŸ”‹ DEV: The batteries included, ***EXPERIMENTAL*** fork of slskd. Feature-rich, including multi-source downloads, DHT mesh sync, swarm mode \& more/' debian/control
          
          # Use timestamp-based PPA revision
          PPA_REV=$(date +%Y%m%d%H%M)
          
          # Update changelog for slskdn-dev (use DEB_VERSION with dots)
          cat > debian/changelog << EOF
          slskdn-dev (${DEB_VERSION}-1ppa${PPA_REV}~jammy) jammy; urgency=medium

            * Development build from experimental/multi-source-swarm
            * Multi-source swarm downloads
            * DHT mesh network
            * BitTorrent DHT rendezvous

           -- slskdn <slskdn@proton.me>  $(date -R)
          EOF

      - name: Build Source Package
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then exit 0; fi
          
          VERSION="${{ needs.parse.outputs.version }}"
          cd slskdn-dev-${VERSION}
          debuild -S -sa -d -k07E2531E1F470F8008ACCFC996A07606FE65392F

      - name: Configure dput
        run: |
          cat > ~/.dput.cf << 'EOF'
          [slskdn-ppa]
          fqdn = ppa.launchpad.net
          method = ftp
          incoming = ~keefshape/ubuntu/slskdn/
          login = anonymous
          allow_unsigned_uploads = 0
          EOF

      - name: Upload to PPA
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "Skipping PPA upload - GPG_PRIVATE_KEY not configured"
            exit 0
          fi
          ls -la *.changes || true
          CHANGES_FILE=$(find . -name "slskdn-dev*.changes" -type f | head -1)
          echo "Found changes file: $CHANGES_FILE"
          dput slskdn-ppa "$CHANGES_FILE"
          echo "âœ… Uploaded to PPA: slskdn-dev"

  docker-dev:
    name: Build and Push Docker (Dev)
    needs: [parse, release-dev]
    if: needs.parse.outputs.channel == 'dev'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download from Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ github.ref_name }}" \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-linux-x64.zip"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Dev Image
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            VERSION=${{ needs.parse.outputs.version }}
          tags: |
            ghcr.io/snapetech/slskdn:dev-${{ needs.parse.outputs.version }}
            ghcr.io/snapetech/slskdn:dev-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "âœ… Published Docker images:"
          echo "  - ghcr.io/snapetech/slskdn:dev-${{ needs.parse.outputs.version }}"
          echo "  - ghcr.io/snapetech/slskdn:dev-latest"

  chocolatey-dev:
    name: Publish to Chocolatey (Dev/Pre)
    needs: [parse, release-dev]
    if: needs.parse.outputs.channel == 'dev'
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download from Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ github.ref_name }}" `
            --repo ${{ github.repository }} `
            --pattern "slskdn-dev-win-x64.zip"

      - name: Pack and Push
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        if: "${{ env.CHOCO_API_KEY != '' }}"
        run: |
          $Version = "${{ needs.parse.outputs.version }}"
          $Url = "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/slskdn-dev-win-x64.zip"
          $Checksum = (Get-FileHash slskdn-dev-win-x64.zip -Algorithm SHA256).Hash
          (Get-Content packaging/chocolatey/slskdn.nuspec) -replace '<version>.*</version>', "<version>$Version</version>" | Set-Content packaging/chocolatey/slskdn.nuspec
          (Get-Content packaging/chocolatey/tools/chocolateyinstall.ps1) -replace '\$url\s*=\s*".*"', "`$url = `"$Url`"" | Set-Content packaging/chocolatey/tools/chocolateyinstall.ps1
          (Get-Content packaging/chocolatey/tools/chocolateyinstall.ps1) -replace '\$checksum\s*=\s*".*"', "`$checksum = `"$Checksum`"" | Set-Content packaging/chocolatey/tools/chocolateyinstall.ps1
          cd packaging/chocolatey
          choco pack
          # Push to pre-release channel for dev builds
          choco push --source https://push.chocolatey.org/ --api-key $env:CHOCO_API_KEY --prerelease
          Write-Host "âœ… Published to Chocolatey: slskdn (pre-release)"
        shell: pwsh

  release-main:
    name: Create Main Release
    needs: [parse, publish]
    if: needs.parse.outputs.channel == 'main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: slskdn-main-*

      - name: Prepare Release Assets
        run: |
          mkdir -p release
          find artifacts -name "*.zip" -exec cp {} release/ \;
          ls -lh release/

      # Creates release under VERSION tag (e.g., 0.24.1-slskdn.35) for backward compatibility
      # Build was triggered by build-main-VERSION tag, but release uses traditional format
      - name: Create Main Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.parse.outputs.version }}
          name: "Release ${{ needs.parse.outputs.version }}"
          body: |
            ## Release ${{ needs.parse.outputs.version }}
            
            **Full changelog:** [View all changes](https://github.com/${{ github.repository }}/compare/previous...${{ needs.parse.outputs.version }})
            
            ### Installation
            **Package Managers:**
            - Arch: `yay -S slskdn` or `yay -S slskdn-bin`
            - Fedora/RHEL: `sudo dnf copr enable slskdn/slskdn && sudo dnf install slskdn`
            - Ubuntu/Debian: `sudo add-apt-repository ppa:keefshape/slskdn && sudo apt install slskdn`
            - Docker: `docker pull ghcr.io/snapetech/slskdn:latest`
            
            **Direct Download:** Extract the archive for your platform and run the binary.
          prerelease: false
          files: release/*

      - name: Trigger Package Workflows
        if: success()
        run: |
          echo "âœ… Main release created: ${{ needs.parse.outputs.version }}"
          echo "ðŸ“¦ Package publishing jobs will run below..."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  aur-main:
    name: Publish to AUR (Main - Source & Binary)
    needs: [parse, release-main]
    if: needs.parse.outputs.channel == 'main'
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.info.outputs.short_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get commit info
        id: info
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Download from Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Download binary for slskdn-bin package
          gh release download "${{ needs.parse.outputs.version }}" \
            --repo ${{ github.repository }} \
            --pattern "slskdn-main-linux-x64.zip"

      - name: Setup SSH for AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then
            echo "âš ï¸ AUR_SSH_KEY not configured, skipping AUR publish"
            exit 0
          fi
          
          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          
          cat >> ~/.ssh/config << EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
          EOF
          
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts

      # Publish slskdn (source package)
      - name: Clone AUR Package (Source)
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then exit 0; fi
          
          git clone ssh://aur@aur.archlinux.org/slskdn.git aur-pkg-source || {
            mkdir -p aur-pkg-source
            cd aur-pkg-source
            git init
            git remote add origin ssh://aur@aur.archlinux.org/slskdn.git
          }

      - name: Update PKGBUILD (Source)
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then exit 0; fi
          
          cd aur-pkg-source
          
          # Copy the main source PKGBUILD template
          cp ../packaging/aur/PKGBUILD PKGBUILD
          cp ../packaging/aur/slskd.install slskd.install
          cp ../packaging/aur/slskd.service slskd.service
          cp ../packaging/aur/slskd.yml slskd.yml
          cp ../packaging/aur/slskd.sysusers slskd.sysusers
          
          # Version for main (convert dots if needed, e.g. 0.25.0)
          ARCH_VERSION=$(echo "${{ needs.parse.outputs.version }}" | sed 's/-/./g')
          
          # Update version
          sed -i "s/^pkgver=.*/pkgver=${ARCH_VERSION}/" PKGBUILD
          
          # Generate .SRCINFO
          docker run --rm -v "$PWD:/pkg" -w /pkg archlinux:base-devel bash -c "
            pacman -Sy --noconfirm pacman-contrib
            useradd -m builder
            chown -R builder:builder /pkg
            su builder -c 'makepkg --printsrcinfo' > .SRCINFO
          "
          
          sudo chown -R $(id -u):$(id -g) .
          
          echo "ðŸ“ Updated PKGBUILD (source):"
          cat PKGBUILD | head -30

      - name: Push to AUR (Source)
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then exit 0; fi
          
          cd aur-pkg-source
          git config user.name "slskdn CI"
          git config user.email "slskdn@proton.me"
          git add PKGBUILD .SRCINFO slskd.install slskd.service slskd.yml slskd.sysusers
          git commit -m "Update to ${{ needs.parse.outputs.version }}" || echo "No changes"
          git push origin master || git push --set-upstream origin master
          
          echo "âœ… Pushed to AUR: slskdn (source)"

      # Publish slskdn-bin (binary package)
      - name: Clone AUR Package (Binary)
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then exit 0; fi
          
          git clone ssh://aur@aur.archlinux.org/slskdn-bin.git aur-pkg-bin || {
            mkdir -p aur-pkg-bin
            cd aur-pkg-bin
            git init
            git remote add origin ssh://aur@aur.archlinux.org/slskdn-bin.git
          }

      - name: Update PKGBUILD (Binary)
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then exit 0; fi
          
          cd aur-pkg-bin
          
          # Copy the binary PKGBUILD template
          cp ../packaging/aur/PKGBUILD-bin PKGBUILD
          cp ../packaging/aur/slskd.install slskd.install
          cp ../packaging/aur/slskd.service slskd.service
          cp ../packaging/aur/slskd.yml slskd.yml
          cp ../packaging/aur/slskd.sysusers slskd.sysusers
          
          # Version for main
          ARCH_VERSION=$(echo "${{ needs.parse.outputs.version }}" | sed 's/-/./g')
          
          # Update version
          sed -i "s/^pkgver=.*/pkgver=${ARCH_VERSION}/" PKGBUILD
          
          # Generate .SRCINFO
          docker run --rm -v "$PWD:/pkg" -w /pkg archlinux:base-devel bash -c "
            pacman -Sy --noconfirm pacman-contrib
            useradd -m builder
            chown -R builder:builder /pkg
            su builder -c 'makepkg --printsrcinfo' > .SRCINFO
          "
          
          sudo chown -R $(id -u):$(id -g) .
          
          echo "ðŸ“ Updated PKGBUILD (binary):"
          cat PKGBUILD | head -30

      - name: Push to AUR (Binary)
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then exit 0; fi
          
          cd aur-pkg-bin
          git config user.name "slskdn CI"
          git config user.email "slskdn@proton.me"
          git add PKGBUILD .SRCINFO slskd.install slskd.service slskd.yml slskd.sysusers
          git commit -m "Update to ${{ needs.parse.outputs.version }}" || echo "No changes"
          git push origin master || git push --set-upstream origin master
          
          echo "âœ… Pushed to AUR: slskdn-bin (binary)"

  copr-main:
    name: Publish to COPR (Main)
    needs: [parse, release-main]
    if: needs.parse.outputs.channel == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download from Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ needs.parse.outputs.version }}" \
            --repo ${{ github.repository }} \
            --pattern "slskdn-main-linux-x64.zip"

      - name: Setup RPM Build
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip rpm
          pip3 install copr-cli
          mkdir -p ~/rpmbuild/{SOURCES,SPECS,SRPMS}

      - name: Prepare Sources
        run: |
          # Copy the built zip to SOURCES
          cp slskdn-main-linux-x64.zip ~/rpmbuild/SOURCES/
          
          # Copy supporting files
          cp packaging/aur/slskd.service ~/rpmbuild/SOURCES/
          cp packaging/aur/slskd.yml ~/rpmbuild/SOURCES/
          cp packaging/aur/slskd.sysusers ~/rpmbuild/SOURCES/slskd.conf

      - name: Update Spec File
        run: |
          # Use the main spec template
          cp packaging/rpm/slskdn.spec ~/rpmbuild/SPECS/
          
          # Convert version for RPM (replace ALL hyphens with dots)
          RPM_VERSION=$(echo "${{ needs.parse.outputs.version }}" | sed 's/-/./g')
          
          # Update version
          sed -i "s/^Version:.*/Version:        ${RPM_VERSION}/" ~/rpmbuild/SPECS/slskdn.spec
          
          cat ~/rpmbuild/SPECS/slskdn.spec | head -30

      - name: Configure COPR
        env:
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
        run: |
          if [ -z "$COPR_LOGIN" ] || [ -z "$COPR_TOKEN" ]; then
            echo "COPR credentials not configured. Skipping."
            exit 0
          fi
          mkdir -p ~/.config
          cat > ~/.config/copr << EOF
          [copr-cli]
          login = ${COPR_LOGIN}
          username = slskdn
          token = ${COPR_TOKEN}
          copr_url = https://copr.fedorainfracloud.org
          EOF

      - name: Build SRPM
        run: |
          rpmbuild -bs ~/rpmbuild/SPECS/slskdn.spec --define "_topdir $HOME/rpmbuild"
          
          SRPM=$(find ~/rpmbuild/SRPMS -name "*.src.rpm" | head -1)
          echo "Built SRPM: $SRPM"
          rpm -qpl "$SRPM" | head -20
          echo "SRPM_PATH=$SRPM" >> $GITHUB_ENV

      - name: Upload to COPR
        env:
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
        run: |
          if [ -z "$COPR_LOGIN" ] || [ -z "$COPR_TOKEN" ]; then
            echo "Skipping COPR upload - credentials not configured"
            exit 0
          fi
          
          echo "Uploading SRPM to COPR: $SRPM_PATH"
          # Upload to slskdn stable project
          copr-cli build slskdn/slskdn "$SRPM_PATH" --nowait
          echo "âœ… Uploaded to COPR: slskdn"

  ppa-main:
    name: Publish to PPA (Main)
    needs: [parse, release-main]
    if: needs.parse.outputs.channel == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download from Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ needs.parse.outputs.version }}" \
            --repo ${{ github.repository }} \
            --pattern "slskdn-main-linux-x64.zip"
          unzip slskdn-main-linux-x64.zip -d publish-linux-x64

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dput gnupg build-essential

      - name: Import GPG Key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "GPG_PRIVATE_KEY secret not set. Skipping PPA upload."
            exit 0
          fi
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          # Trust the key
          KEY_ID=$(gpg --list-keys --keyid-format long | grep -A1 "^pub" | tail -1 | awk '{print $1}')
          echo "$KEY_ID:6:" | gpg --import-ownertrust

      - name: Prepare Source Structure
        run: |
          VERSION="${{ needs.parse.outputs.version }}"
          
          # Create proper directory structure for debian packaging
          mkdir -p slskdn-${VERSION}/usr/lib/slskd
          mkdir -p slskdn-${VERSION}/lib/systemd/system
          mkdir -p slskdn-${VERSION}/etc/slskd
          mkdir -p slskdn-${VERSION}/usr/lib/sysusers.d
          
          # Copy binary files from our build
          cp -r publish-linux-x64/* slskdn-${VERSION}/usr/lib/slskd/
          
          # Copy service files from packaging
          cp packaging/aur/slskd.service slskdn-${VERSION}/lib/systemd/system/
          cp packaging/aur/slskd.yml slskdn-${VERSION}/etc/slskd/
          cp packaging/aur/slskd.sysusers slskdn-${VERSION}/usr/lib/sysusers.d/slskd.conf

      - name: Prepare Source Package
        run: |
          VERSION="${{ needs.parse.outputs.version }}"
          # Convert version for Debian (replace ALL hyphens with dots)
          DEB_VERSION=$(echo "$VERSION" | sed 's/-/./g')
          
          # Create tarball for orig source
          tar -czvf slskdn_${DEB_VERSION}.orig.tar.gz slskdn-${VERSION}
          
          # Copy debian directory for stable package
          cp -r packaging/debian slskdn-${VERSION}/
          
          # Update control file for slskdn stable package
          cd slskdn-${VERSION}
          
          # Use timestamp-based PPA revision
          PPA_REV=$(date +%Y%m%d%H%M)
          
          # Update changelog for slskdn stable (use DEB_VERSION with dots)
          cat > debian/changelog << EOF
          slskdn (${DEB_VERSION}-1ppa${PPA_REV}~jammy) jammy; urgency=medium

            * Stable release
            * Multi-source swarm downloads
            * DHT mesh network
            * Enhanced security features

           -- slskdn <slskdn@proton.me>  $(date -R)
          EOF

      - name: Build Source Package
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then exit 0; fi
          
          VERSION="${{ needs.parse.outputs.version }}"
          cd slskdn-${VERSION}
          debuild -S -sa -d -k07E2531E1F470F8008ACCFC996A07606FE65392F

      - name: Configure dput
        run: |
          cat > ~/.dput.cf << 'EOF'
          [slskdn-ppa]
          fqdn = ppa.launchpad.net
          method = ftp
          incoming = ~keefshape/ubuntu/slskdn/
          login = anonymous
          allow_unsigned_uploads = 0
          EOF

      - name: Upload to PPA
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "Skipping PPA upload - GPG_PRIVATE_KEY not configured"
            exit 0
          fi
          ls -la *.changes || true
          CHANGES_FILE=$(find . -name "slskdn_*.changes" -type f | head -1)
          echo "Found changes file: $CHANGES_FILE"
          dput slskdn-ppa "$CHANGES_FILE"
          echo "âœ… Uploaded to PPA: slskdn"

  docker-main:
    name: Build and Push Docker (Main)
    needs: [parse, release-main]
    if: needs.parse.outputs.channel == 'main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download from Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ needs.parse.outputs.version }}" \
            --repo ${{ github.repository }} \
            --pattern "slskdn-main-linux-x64.zip"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Main Image
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            VERSION=${{ needs.parse.outputs.version }}
          tags: |
            ghcr.io/snapetech/slskdn:${{ needs.parse.outputs.version }}
            ghcr.io/snapetech/slskdn:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "âœ… Published Docker images:"
          echo "  - ghcr.io/snapetech/slskdn:${{ needs.parse.outputs.version }}"
          echo "  - ghcr.io/snapetech/slskdn:latest"

  chocolatey-main:
    name: Publish to Chocolatey (Stable)
    needs: [parse, release-main]
    if: needs.parse.outputs.channel == 'main'
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download from Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ needs.parse.outputs.version }}" `
            --repo ${{ github.repository }} `
            --pattern "slskdn-main-win-x64.zip"

      - name: Pack and Push
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        if: "${{ env.CHOCO_API_KEY != '' }}"
        run: |
          $Version = "${{ needs.parse.outputs.version }}"
          $Url = "https://github.com/${{ github.repository }}/releases/download/${{ needs.parse.outputs.version }}/slskdn-main-win-x64.zip"
          $Checksum = (Get-FileHash slskdn-main-win-x64.zip -Algorithm SHA256).Hash
          (Get-Content packaging/chocolatey/slskdn.nuspec) -replace '<version>.*</version>', "<version>$Version</version>" | Set-Content packaging/chocolatey/slskdn.nuspec
          (Get-Content packaging/chocolatey/tools/chocolateyinstall.ps1) -replace '\$url\s*=\s*".*"', "`$url = `"$Url`"" | Set-Content packaging/chocolatey/tools/chocolateyinstall.ps1
          (Get-Content packaging/chocolatey/tools/chocolateyinstall.ps1) -replace '\$checksum\s*=\s*".*"', "`$checksum = `"$Checksum`"" | Set-Content packaging/chocolatey/tools/chocolateyinstall.ps1
          cd packaging/chocolatey
          choco pack
          # Push to stable channel (no --prerelease flag)
          choco push --source https://push.chocolatey.org/ --api-key $env:CHOCO_API_KEY
          Write-Host "âœ… Published to Chocolatey: slskdn (stable)"
        shell: pwsh


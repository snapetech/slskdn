name: Upload to COPR

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to upload to COPR'
        required: true

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          VERSION=$(echo "$TAG" | sed 's/-slskdN/.slskdN/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/web/package-lock.json

      - name: Build Frontend
        working-directory: src/web
        run: |
          npm ci
          npm run build

      - name: Build Backend
        run: |
          dotnet publish src/slskd/slskd.csproj \
            -c Release \
            -o publish-linux-x64 \
            --self-contained true \
            -r linux-x64

      - name: Copy Web Assets
        run: |
          cp -r src/web/build/* publish-linux-x64/wwwroot/

      - name: Create Zip
        run: |
          cd publish-linux-x64
          zip -r ../slskdN-${{ steps.version.outputs.tag }}-linux-x64.zip .
          cd ..
          mkdir -p ~/rpmbuild/SOURCES
          cp slskdN-${{ steps.version.outputs.tag }}-linux-x64.zip ~/rpmbuild/SOURCES/

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip rpm
          pip3 install copr-cli

      - name: Configure COPR
        env:
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
        run: |
          if [ -z "$COPR_LOGIN" ] || [ -z "$COPR_TOKEN" ]; then
            echo "COPR credentials not configured. Skipping."
            exit 0
          fi
          mkdir -p ~/.config
          cat > ~/.config/copr << EOF
          [copr-cli]
          login = ${COPR_LOGIN}
          username = slskdN
          token = ${COPR_TOKEN}
          copr_url = https://copr.fedorainfracloud.org
          EOF

      - name: Update spec version
        run: |
          sed -i "s/^Version:.*/Version:        ${{ steps.version.outputs.version }}/" packaging/rpm/slskdN.spec
          # Use local filename (not URL) so SRPM includes the file
          sed -i "s|^Source0:.*|Source0:        slskdN-${{ steps.version.outputs.tag }}-linux-x64.zip|" packaging/rpm/slskdN.spec
          cat packaging/rpm/slskdN.spec | head -20

      - name: Build SRPM
        run: |
          mkdir -p ~/rpmbuild/{SPECS,SRPMS}
          
          # Copy supporting files
          cp packaging/aur/slskd.service ~/rpmbuild/SOURCES/
          cp packaging/aur/slskd.yml ~/rpmbuild/SOURCES/
          cp packaging/aur/slskd.sysusers ~/rpmbuild/SOURCES/slskd.conf
          cp packaging/rpm/slskdN.spec ~/rpmbuild/SPECS/
          
          # Build SRPM
          rpmbuild -bs ~/rpmbuild/SPECS/slskdN.spec --define "_topdir $HOME/rpmbuild"
          
          SRPM=$(find ~/rpmbuild/SRPMS -name "*.src.rpm" | head -1)
          echo "Built SRPM: $SRPM"
          rpm -qpl "$SRPM" | head -20

      - name: Upload to COPR
        env:
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
        run: |
          if [ -z "$COPR_LOGIN" ] || [ -z "$COPR_TOKEN" ]; then
            echo "Skipping COPR upload - credentials not configured"
            exit 0
          fi
          
          SRPM=$(find ~/rpmbuild/SRPMS -name "*.src.rpm" | head -1)
          echo "Uploading SRPM to COPR: $SRPM"
          copr-cli build slskdN "$SRPM" --nowait

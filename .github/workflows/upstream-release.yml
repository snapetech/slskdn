name: Upstream Release Sync

on:
  schedule:
    # Check for new upstream releases every 6 hours (offset from sync)
    - cron: '30 */6 * * *'
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force a new release even if versions match'
        required: false
        default: 'false'

jobs:
  check-upstream-release:
    runs-on: ubuntu-latest
    outputs:
      new_release: ${{ steps.check.outputs.new_release }}
      upstream_version: ${{ steps.check.outputs.upstream_version }}
      current_base: ${{ steps.check.outputs.current_base }}
      new_version: ${{ steps.check.outputs.new_version }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for New Upstream Release
        id: check
        run: |
          # Get latest slskd release version
          UPSTREAM_VERSION=$(curl -s https://api.github.com/repos/slskd/slskd/releases/latest | jq -r '.tag_name')
          echo "Latest slskd release: $UPSTREAM_VERSION"
          echo "upstream_version=${UPSTREAM_VERSION}" >> $GITHUB_OUTPUT
          
          # Get our current base version (from latest release tag)
          OUR_LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0-slskdn.0")
          # Extract base version (e.g., 0.24.1 from 0.24.1-slskdn.5)
          CURRENT_BASE=$(echo "$OUR_LATEST" | sed 's/-slskdn.*//')
          echo "Our current base: $CURRENT_BASE"
          echo "current_base=${CURRENT_BASE}" >> $GITHUB_OUTPUT
          
          # Compare versions
          if [ "$UPSTREAM_VERSION" != "$CURRENT_BASE" ] || [ "${{ github.event.inputs.force_release }}" == "true" ]; then
            echo "üÜï New upstream release detected: $UPSTREAM_VERSION (we have $CURRENT_BASE)"
            echo "new_release=true" >> $GITHUB_OUTPUT
            
            # Calculate new version
            NEW_VERSION="${UPSTREAM_VERSION}-slskdn.1"
            echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Already synced with upstream release $UPSTREAM_VERSION"
            echo "new_release=false" >> $GITHUB_OUTPUT
          fi

  sync-and-release:
    needs: check-upstream-release
    if: needs.check-upstream-release.outputs.new_release == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "slskdn"
          git config user.email "slskdn@proton.me"

      - name: Add Upstream and Fetch
        run: |
          git remote add upstream https://github.com/slskd/slskd.git || true
          git fetch upstream
          git fetch upstream --tags

      - name: Merge Upstream Release Tag
        id: merge
        run: |
          UPSTREAM_TAG="${{ needs.check-upstream-release.outputs.upstream_version }}"
          echo "Merging upstream tag: $UPSTREAM_TAG"
          
          # Try to merge the specific release tag
          if git merge "upstream/master" --no-edit -m "chore: Sync with upstream slskd $UPSTREAM_TAG release"; then
            echo "merge_success=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Merge successful!"
          else
            echo "merge_success=false" >> $GITHUB_OUTPUT
            echo "‚ùå Merge conflicts - manual intervention required"
            
            # Get conflicting files
            CONFLICTS=$(git diff --name-only --diff-filter=U)
            echo "conflicts<<EOF" >> $GITHUB_OUTPUT
            echo "$CONFLICTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            git merge --abort
          fi

      - name: Create Issue on Conflict
        if: steps.merge.outputs.merge_success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const conflicts = `${{ steps.merge.outputs.conflicts }}`;
            const upstreamVersion = `${{ needs.check-upstream-release.outputs.upstream_version }}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Upstream release ${upstreamVersion} requires manual merge`,
              labels: ['upstream-sync', 'needs-attention', 'release-blocked'],
              body: `## New Upstream Release Detected\n\nslskd has released **${upstreamVersion}** but automatic merge failed.\n\n### Conflicting files:\n\`\`\`\n${conflicts}\n\`\`\`\n\n### To resolve:\n\n\`\`\`bash\ngit remote add upstream https://github.com/slskd/slskd.git\ngit fetch upstream --tags\ngit merge upstream/master\n# resolve conflicts\ngit add .\ngit commit\ngit push\n\n# Then create the release tag:\ngit tag ${upstreamVersion}-slskdn.1\ngit push origin ${upstreamVersion}-slskdn.1\n\`\`\`\n\nThe new slskdn release should be **${upstreamVersion}-slskdn.1**`
            });

      - name: Push Changes
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          git push origin master

      - name: Update PKGBUILDs
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          NEW_VERSION="${{ needs.check-upstream-release.outputs.new_version }}"
          PKGVER=$(echo "$NEW_VERSION" | sed 's/-slskdn/.slskdn/')
          
          # Update PKGBUILD-bin
          sed -i "s/^pkgver=.*/pkgver=${PKGVER}/" packaging/aur/PKGBUILD-bin
          sed -i "s/^pkgrel=.*/pkgrel=1/" packaging/aur/PKGBUILD-bin
          
          # Update PKGBUILD (source)
          sed -i "s/^pkgver=.*/pkgver=${PKGVER}/" packaging/aur/PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" packaging/aur/PKGBUILD
          
          git add packaging/aur/
          git commit -m "chore: Update PKGBUILDs to ${NEW_VERSION}" || true
          git push origin master

      - name: Create Release Tag
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          NEW_VERSION="${{ needs.check-upstream-release.outputs.new_version }}"
          git tag "$NEW_VERSION"
          git push origin "$NEW_VERSION"
          echo "üè∑Ô∏è Created tag: $NEW_VERSION"

      - name: Create Release Notes
        if: steps.merge.outputs.merge_success == 'true'
        id: notes
        run: |
          UPSTREAM_VERSION="${{ needs.check-upstream-release.outputs.upstream_version }}"
          NEW_VERSION="${{ needs.check-upstream-release.outputs.new_version }}"
          OLD_BASE="${{ needs.check-upstream-release.outputs.current_base }}"
          
          cat > /tmp/release-notes.md << EOF
          ## slskdn ${NEW_VERSION}
          
          ### üîÑ Upstream Sync Release
          
          This release syncs slskdn with **slskd ${UPSTREAM_VERSION}**.
          
          See [slskd ${UPSTREAM_VERSION} release notes](https://github.com/slskd/slskd/releases/tag/${UPSTREAM_VERSION}) for upstream changes.
          
          ---
          
          **Drop-in replacement for slskd** - Install via AUR and your existing config/data at \`/var/lib/slskd/\` is preserved.
          
          ### slskdn Features (on top of slskd)
          - üîç **Wishlist** - Track and auto-search for music you want
          - üß† **Smart source ranking** with download history
          - üìÑ **Configurable search page size** (25/50/100 results)
          - üíæ **Save search filters as default**
          - üìè **Max file size filter**
          - üóëÔ∏è **Delete files on disk** when removing downloads
          - üì± **PWA support** for mobile
          - üìÇ **Tabbed browsing** with caching
          - üå≥ **Collapsible tree view** with multi-select downloads
          - üîî **Ntfy/Pushover notifications**
          
          ### Installation (Arch Linux)
          \`\`\`bash
          yay -S slskdn-bin
          \`\`\`
          
          ### Docker
          \`\`\`bash
          docker pull ghcr.io/snapetech/slskdn:${NEW_VERSION}
          \`\`\`
          EOF
          
          echo "Release notes created"

      # The CI workflow will handle creating the actual release when it sees the tag

      - name: Summary
        run: |
          echo "## Upstream Release Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.merge.outputs.merge_success }}" == "true" ]; then
            echo "‚úÖ **Successfully synced with slskd ${{ needs.check-upstream-release.outputs.upstream_version }}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "New release: **${{ needs.check-upstream-release.outputs.new_version }}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The CI workflow will now build and publish the release." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Merge failed - manual intervention required**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A GitHub issue has been created." >> $GITHUB_STEP_SUMMARY
          fi


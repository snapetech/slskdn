name: Upload to PPA

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to upload to PPA'
        required: true

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          # Convert 0.24.1-slskdn.7 to 0.24.1.slskdn.7 for debian version
          VERSION=$(echo "$TAG" | sed 's/-slskdn/.slskdn/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/web/package-lock.json

      - name: Build Frontend
        working-directory: src/web
        run: |
          npm ci
          npm run build

      - name: Build Backend
        run: |
          dotnet publish src/slskd/slskd.csproj \
            -c Release \
            -o publish-linux-x64 \
            --self-contained true \
            -r linux-x64

      - name: Copy Web Assets
        run: |
          cp -r src/web/build/* publish-linux-x64/wwwroot/

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dput gnupg build-essential

      - name: Import GPG Key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "GPG_PRIVATE_KEY secret not set. Skipping PPA upload."
            exit 0
          fi
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          # Trust the key
          KEY_ID=$(gpg --list-keys --keyid-format long | grep -A1 "^pub" | tail -1 | awk '{print $1}')
          echo "$KEY_ID:6:" | gpg --import-ownertrust

      - name: Prepare Source Structure
        run: |
          # Create proper directory structure for debian packaging
          mkdir -p slskdn-${{ steps.version.outputs.version }}/usr/lib/slskd
          mkdir -p slskdn-${{ steps.version.outputs.version }}/lib/systemd/system
          mkdir -p slskdn-${{ steps.version.outputs.version }}/etc/slskd
          mkdir -p slskdn-${{ steps.version.outputs.version }}/usr/lib/sysusers.d
          
          # Copy binary files from our build
          cp -r publish-linux-x64/* slskdn-${{ steps.version.outputs.version }}/usr/lib/slskd/
          
          # Copy service files from packaging
          cp packaging/aur/slskd.service slskdn-${{ steps.version.outputs.version }}/lib/systemd/system/
          cp packaging/aur/slskd.yml slskdn-${{ steps.version.outputs.version }}/etc/slskd/
          cp packaging/aur/slskd.sysusers slskdn-${{ steps.version.outputs.version }}/usr/lib/sysusers.d/slskd.conf

      - name: Prepare Source Package
        run: |
          # Create tarball for orig source
          tar -czvf slskdn_${{ steps.version.outputs.version }}.orig.tar.gz slskdn-${{ steps.version.outputs.version }}
          
          # Copy debian directory
          cp -r packaging/debian slskdn-${{ steps.version.outputs.version }}/
          
          # Use timestamp-based PPA revision to avoid conflicts on rebuilds
          PPA_REV=$(date +%Y%m%d%H%M)
          
          # Update changelog
          cd slskdn-${{ steps.version.outputs.version }}
          cat > debian/changelog << EOF
          slskdn (${{ steps.version.outputs.version }}-1ppa${PPA_REV}~jammy) jammy; urgency=medium
          
            * Release ${{ steps.version.outputs.tag }}
          
           -- slskdn <slskdn@proton.me>  $(date -R)
          EOF

      - name: Build Source Package
        run: |
          cd slskdn-${{ steps.version.outputs.version }}
          debuild -S -sa -d -k07E2531E1F470F8008ACCFC996A07606FE65392F

      - name: Configure dput
        run: |
          cat > ~/.dput.cf << 'EOF'
          [slskdn-ppa]
          fqdn = ppa.launchpad.net
          method = ftp
          incoming = ~keefshape/ubuntu/slskdn/
          login = anonymous
          allow_unsigned_uploads = 0
          EOF

      - name: Upload to PPA
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "Skipping PPA upload - GPG_PRIVATE_KEY not configured"
            exit 0
          fi
          ls -la *.changes || true
          CHANGES_FILE=$(find . -name "*.changes" -type f | head -1)
          echo "Found changes file: $CHANGES_FILE"
          dput slskdn-ppa "$CHANGES_FILE"

name: Dev Release (AUR + COPR)

# Build and push -dev packages only when explicitly tagged
on:
  push:
    tags:
      - 'dev-*'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no changes'
        required: false
        default: 'false'

env:
  DOTNET_VERSION: '8'
  BASE_VERSION: '0.24.1'

jobs:
  build:
    name: Build Dev Release
    runs-on: ${{ vars.PREFER_SELF_HOSTED != 'false' && 'self-hosted' || 'ubuntu-latest' }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      dev_version: ${{ steps.version.outputs.dev_version }}
      short_sha: ${{ steps.version.outputs.short_sha }}
      timestamp: ${{ steps.version.outputs.timestamp }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up .NET (GitHub-hosted)
        if: ${{ !contains(runner.name, 'keith') }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Verify .NET (self-hosted)
        if: ${{ contains(runner.name, 'keith') }}
        run: dotnet --version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/web/package-lock.json

      - name: Set Version
        id: version
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
          # Version format: 0.24.1-dev-YYYYMMDD-HHMMSS (tag format)
          # For NuGet/PKGBUILD: replace hyphens in timestamp portion
          DEV_VERSION="${BASE_VERSION}-dev-${TIMESTAMP}"
          
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "dev_version=${DEV_VERSION}" >> $GITHUB_OUTPUT
          echo "version=${DEV_VERSION}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "VERSION=${DEV_VERSION}" >> $GITHUB_ENV
          
          echo "ðŸ“¦ Building version: ${DEV_VERSION} (commit: ${SHORT_SHA})"

      - name: Build Frontend
        working-directory: src/web
        run: |
          npm ci
          DISABLE_ESLINT_PLUGIN=true npm run build

      - name: Build Backend
        run: |
          dotnet publish src/slskd/slskd.csproj \
            -c Release \
            -o publish-linux-x64 \
            --self-contained true \
            -r linux-x64 \
            /p:Version=${{ env.VERSION }}

      - name: Copy Web Assets
        run: |
          cp -r src/web/build/* publish-linux-x64/wwwroot/

      - name: Create Release Archive
        run: |
          cd publish-linux-x64
          zip -r ../slskdn-dev-linux-x64.zip .
          cd ..
          ls -lh slskdn-dev-linux-x64.zip

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: slskdn-dev-linux-x64
          path: slskdn-dev-linux-x64.zip
          retention-days: 30

  release:
    name: Create Dev Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: experimental/multi-source-swarm
          fetch-depth: 0

      - name: Update README with Latest Dev Build
        run: |
          # Extract version and tag info
          TAG_NAME="${{ github.ref_name }}"
          VERSION="${{ needs.build.outputs.dev_version }}"
          
          # Ensure we're on latest branch state
          git fetch origin experimental/multi-source-swarm
          git reset --hard origin/experimental/multi-source-swarm
          
          # Update README.md dev build section
          sed -i '/<!-- BEGIN_DEV_BUILD -->/,/<!-- END_DEV_BUILD -->/c\
          <!-- BEGIN_DEV_BUILD -->\
          **[Development Build '"${TAG_NAME}"' â†’](https://github.com/snapetech/slskdn/releases/tag/'"${TAG_NAME}"')** \
          \
          Version: `'"${VERSION}"'` | Branch: `experimental/multi-source-swarm` \
          \
          ```bash\
          # Arch Linux (AUR)\
          yay -S slskdn-dev\
          \
          # Fedora/RHEL (COPR)\
          sudo dnf copr enable slskdn/slskdn-dev\
          sudo dnf install slskdn-dev\
          \
          # Ubuntu/Debian (PPA)\
          sudo add-apt-repository ppa:keefshape/slskdn\
          sudo apt update\
          sudo apt install slskdn-dev\
          \
          # Docker\
          docker pull ghcr.io/snapetech/slskdn:dev\
          ```\
          <!-- END_DEV_BUILD -->' README.md
          
          # Verify the change
          echo "ðŸ“ Updated README.md with build ${VERSION}"
          grep -A 20 "BEGIN_DEV_BUILD" README.md

      - name: Commit and Push README Update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet README.md; then
            echo "No changes to README.md"
          else
            git add README.md
            git commit -m "docs: update README with dev build ${{ needs.build.outputs.dev_version }} [skip ci]"
            
            # Retry push up to 3 times with exponential backoff to handle concurrent builds
            for i in 1 2 3; do
              if git push origin HEAD:experimental/multi-source-swarm; then
                echo "âœ… README.md updated and pushed"
                break
              else
                if [ $i -eq 3 ]; then
                  echo "âš ï¸ Push failed after 3 attempts, likely already updated by another build"
                  exit 0
                fi
                echo "Push failed, retrying in $((i*2)) seconds..."
                sleep $((i*2))
                git fetch origin experimental/multi-source-swarm
                git reset --hard origin/experimental/multi-source-swarm
                # Re-apply changes if they were lost
                if ! git diff --quiet README.md; then
                  git add README.md
                  git commit -m "docs: update README with dev build ${{ needs.build.outputs.dev_version }} [skip ci]"
                fi
              fi
            done
          fi

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: slskdn-dev-linux-x64

      - name: Create Timestamped Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "ðŸ§ª Dev Build ${{ needs.build.outputs.dev_version }}"
          body: |
            ## Development Build ${{ needs.build.outputs.dev_version }}
            
            **Commit:** ${{ needs.build.outputs.short_sha }}
            **Built:** ${{ github.event.head_commit.timestamp }}
            
            ### âš ï¸ Experimental Features
            - ðŸ”€ Multi-source swarm downloads
            - ðŸŒ DHT mesh network with content verification
            - ðŸ”— BitTorrent DHT rendezvous for peer discovery
            - ðŸ”’ TLS-secured mesh connections
            - ðŸ“Š Distributed hash database with mesh sync
            
            ### Changes in this build
            See commit ${{ needs.build.outputs.short_sha }} for details.
            
            ### Installation
            **Package Managers** (recommended):
            - Arch: `yay -S slskdn-dev`
            - Fedora/RHEL: `sudo dnf copr enable slskdn/slskdn-dev && sudo dnf install slskdn-dev`
            - Ubuntu/Debian: `sudo add-apt-repository ppa:keefshape/slskdn && sudo apt install slskdn-dev`
            - Docker: `docker pull ghcr.io/snapetech/slskdn:dev-latest`
            
            **Direct Download**: Extract the zip below and run `./slskd`
          prerelease: false
          files: slskdn-dev-linux-x64.zip

      - name: Delete Previous Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete the old dev release if it exists
          gh release delete dev --yes --repo ${{ github.repository }} 2>/dev/null || true
          git push origin :refs/tags/dev 2>/dev/null || true

      - name: Create Dev Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: dev
          name: "ðŸ§ª Development Build"
          body: |
            ## Development Build
            
            **Version:** ${{ needs.build.outputs.version }}
            **Branch:** experimental/multi-source-swarm
            **Commit:** ${{ needs.build.outputs.short_sha }}
            **Built:** ${{ github.event.head_commit.timestamp }}
            
            ### âš ï¸ Warning
            This is an **unstable development build** from the experimental branch.
            It includes cutting-edge features that may contain bugs.
            
            ### Features in this build:
            - ðŸ”€ **Multi-source swarm downloads** - Download from multiple peers simultaneously
            - ðŸŒ **DHT mesh network** - Distributed hash table for content verification
            - ðŸ”— **BitTorrent DHT rendezvous** - Peer discovery via mainline DHT
            - ðŸ”’ **TLS overlay protocol** - Secure mesh connections
            - ðŸ“Š **Hash database** - Local SQLite with mesh sync
            
            ### Install
            ```bash
            # Arch Linux (AUR)
            yay -S slskdn-dev
            
            # Fedora/RHEL (COPR)
            sudo dnf copr enable slskdn/slskdn-dev
            sudo dnf install slskdn-dev
            
            # Ubuntu/Debian (PPA)
            sudo add-apt-repository ppa:keefshape/slskdn
            sudo apt update
            sudo apt install slskdn-dev
            ```
          prerelease: true
          files: slskdn-dev-linux-x64.zip

  aur:
    name: Publish to AUR
    runs-on: ubuntu-latest
    needs: [build, release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: experimental/multi-source-swarm

      - name: Download from Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Download from the dev release we just created
          gh release download dev \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-linux-x64.zip"

      - name: Calculate SHA256
        id: sha
        run: |
          SHA256=$(sha256sum slskdn-dev-linux-x64.zip | cut -d' ' -f1)
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          echo "SHA256: ${SHA256}"

      - name: Setup SSH for AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then
            echo "AUR_SSH_KEY not configured, skipping AUR publish"
            exit 0
          fi
          
          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          
          cat >> ~/.ssh/config << EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
          EOF
          
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts

      - name: Clone AUR Package
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then exit 0; fi
          
          git clone ssh://aur@aur.archlinux.org/slskdn-dev.git aur-pkg || {
            # If package doesn't exist yet, create it
            mkdir -p aur-pkg
            cd aur-pkg
            git init
            git remote add origin ssh://aur@aur.archlinux.org/slskdn-dev.git
          }

      - name: Update PKGBUILD
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then exit 0; fi
          
          cd aur-pkg
          
          # Copy the dev PKGBUILD template and install file
          cp ../packaging/aur/PKGBUILD-dev PKGBUILD
          cp ../packaging/aur/slskd.install slskd.install
          
          # Convert version for Arch (replace ALL hyphens with dots)
          # 0.24.1-dev-20251209-203936 â†’ 0.24.1.dev.20251209.203936
          ARCH_VERSION=$(echo "${{ needs.build.outputs.dev_version }}" | sed 's/-/./g')
          
          # Update version and commit (keep sha256sums as-is with SKIP for the zip)
          sed -i "s/^pkgver=.*/pkgver=${ARCH_VERSION}/" PKGBUILD
          sed -i "s/^_commit=.*/_commit=${{ needs.build.outputs.short_sha }}/" PKGBUILD
          
          # Generate .SRCINFO
          docker run --rm -v "$PWD:/pkg" -w /pkg archlinux:base-devel bash -c "
            pacman -Sy --noconfirm pacman-contrib
            useradd -m builder
            chown -R builder:builder /pkg
            su builder -c 'makepkg --printsrcinfo' > .SRCINFO
          "
          
          # Fix ownership after docker (docker runs as root and changes permissions)
          sudo chown -R $(id -u):$(id -g) .
          
          cat PKGBUILD
          cat .SRCINFO

      - name: Push to AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then
            echo "Skipping AUR push - credentials not configured"
            exit 0
          fi
          
          cd aur-pkg
          git config user.name "slskdn CI"
          git config user.email "slskdn@proton.me"
          git add PKGBUILD .SRCINFO slskd.install
          git commit -m "Update to ${{ needs.build.outputs.dev_version }}" || echo "No changes to commit"
          git push origin master || git push --set-upstream origin master

  nix:
    name: Update Nix Flake
    runs-on: ubuntu-latest
    needs: [build, release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: experimental/multi-source-swarm
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Download Dev Release Artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Download all dev build artifacts from the floating dev release
          gh release download dev \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-*.zip"
          
          ls -lh slskdn-dev-*.zip

      - name: Calculate Hashes
        id: hashes
        run: |
          # Calculate SHA256 for all platforms
          LINUX_X64_SHA=$(nix-hash --type sha256 --flat --base32 slskdn-dev-linux-x64.zip)
          
          # ARM64 Linux (if exists)
          if [ -f slskdn-dev-linux-arm64.zip ]; then
            LINUX_ARM64_SHA=$(nix-hash --type sha256 --flat --base32 slskdn-dev-linux-arm64.zip)
          else
            LINUX_ARM64_SHA="0000000000000000000000000000000000000000000000000000"
          fi
          
          # macOS binaries (if exist)
          if [ -f slskdn-dev-osx-x64.zip ]; then
            MACOS_X64_SHA=$(nix-hash --type sha256 --flat --base32 slskdn-dev-osx-x64.zip)
          else
            MACOS_X64_SHA="0000000000000000000000000000000000000000000000000000"
          fi
          
          if [ -f slskdn-dev-osx-arm64.zip ]; then
            MACOS_ARM64_SHA=$(nix-hash --type sha256 --flat --base32 slskdn-dev-osx-arm64.zip)
          else
            MACOS_ARM64_SHA="0000000000000000000000000000000000000000000000000000"
          fi
          
          echo "linux_x64_sha=$LINUX_X64_SHA" >> $GITHUB_OUTPUT
          echo "linux_arm64_sha=$LINUX_ARM64_SHA" >> $GITHUB_OUTPUT
          echo "macos_x64_sha=$MACOS_X64_SHA" >> $GITHUB_OUTPUT
          echo "macos_arm64_sha=$MACOS_ARM64_SHA" >> $GITHUB_OUTPUT
          
          echo "Linux x64:     $LINUX_X64_SHA"
          echo "Linux ARM64:   $LINUX_ARM64_SHA"
          echo "macOS x64:     $MACOS_X64_SHA"
          echo "macOS ARM64:   $MACOS_ARM64_SHA"

      - name: Update flake.nix
        run: |
          # Ensure we're on latest branch state before modifying
          git fetch origin experimental/multi-source-swarm
          git reset --hard origin/experimental/multi-source-swarm
          
          # Update devVersion
          sed -i "s/devVersion = \".*\";/devVersion = \"${{ needs.build.outputs.dev_version }}\";/" flake.nix
          
          # Update devSources hashes
          sed -i '/devSources = {/,/};/s|sha256 = ".*"; # x86_64-linux|sha256 = "${{ steps.hashes.outputs.linux_x64_sha }}"; # x86_64-linux|' flake.nix
          sed -i '/devSources = {/,/};/s|sha256 = ".*"; # aarch64-linux|sha256 = "${{ steps.hashes.outputs.linux_arm64_sha }}"; # aarch64-linux|' flake.nix
          sed -i '/devSources = {/,/};/s|sha256 = ".*"; # x86_64-darwin|sha256 = "${{ steps.hashes.outputs.macos_x64_sha }}"; # x86_64-darwin|' flake.nix
          sed -i '/devSources = {/,/};/s|sha256 = ".*"; # aarch64-darwin|sha256 = "${{ steps.hashes.outputs.macos_arm64_sha }}"; # aarch64-darwin|' flake.nix
          
          echo "ðŸ“ Updated flake.nix:"
          git diff flake.nix

      - name: Verify Flake
        run: |
          nix flake check --no-build || echo "âš ï¸ Flake check failed (non-fatal)"
          echo "âœ… Flake syntax valid"

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet flake.nix; then
            echo "No changes to flake.nix"
          else
            git add flake.nix
            git commit -m "chore(nix): update dev flake to ${{ needs.build.outputs.dev_version }} [skip ci]"
            
            # Retry push up to 3 times with exponential backoff to handle concurrent builds
            for i in 1 2 3; do
              if git push origin HEAD:experimental/multi-source-swarm; then
                echo "âœ… flake.nix updated and pushed"
                break
              else
                if [ $i -eq 3 ]; then
                  echo "âš ï¸ Push failed after 3 attempts, likely already updated by another build"
                  exit 0
                fi
                echo "Push failed, retrying in $((i*2)) seconds..."
                sleep $((i*2))
                git fetch origin experimental/multi-source-swarm
                git reset --hard origin/experimental/multi-source-swarm
                # Re-apply changes if they were lost
                if ! git diff --quiet flake.nix; then
                  git add flake.nix
                  git commit -m "chore(nix): update dev flake to ${{ needs.build.outputs.dev_version }} [skip ci]"
                fi
              fi
            done
          fi

  winget:
    name: Update Winget Manifests
    runs-on: windows-latest
    needs: [build, release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: experimental/multi-source-swarm
          fetch-depth: 0

      - name: Download Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Download Windows x64 build from dev release
          gh release download dev `
            --repo ${{ github.repository }} `
            --pattern "slskdn-dev-windows-x64.zip"
          
          if (Test-Path "slskdn-dev-windows-x64.zip") {
            Write-Host "âœ… Downloaded slskdn-dev-windows-x64.zip"
            Get-Item slskdn-dev-windows-x64.zip | Select-Object Name, Length
          } else {
            Write-Host "âŒ Windows x64 build not found in dev release"
            Write-Host "This is expected if Windows builds aren't published yet"
            exit 0
          }
        shell: pwsh

      - name: Calculate SHA256
        id: sha
        run: |
          if (Test-Path "slskdn-dev-windows-x64.zip") {
            $hash = (Get-FileHash -Algorithm SHA256 "slskdn-dev-windows-x64.zip").Hash
            Write-Host "SHA256: $hash"
            "win_x64_sha=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "has_windows=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            "has_windows=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }
        shell: pwsh

      - name: Update Winget Manifests
        if: steps.sha.outputs.has_windows == 'true'
        run: |
          # Ensure we're on latest branch state before modifying
          git fetch origin experimental/multi-source-swarm
          git reset --hard origin/experimental/multi-source-swarm
          
          # Convert version for Winget (dots only)
          $WINGET_VERSION = "${{ needs.build.outputs.dev_version }}" -replace '-','.'
          $WIN_URL = "https://github.com/snapetech/slskdn/releases/download/dev/slskdn-dev-windows-x64.zip"
          $WIN_SHA = "${{ steps.sha.outputs.win_x64_sha }}"
          
          bash packaging/scripts/update-winget-manifests.sh `
            "${{ needs.build.outputs.dev_version }}" `
            "$WIN_URL" `
            "$WIN_SHA"
          
          Write-Host "ðŸ“ Updated Winget manifests:"
          Get-Content packaging/winget/snapetech.slskdn-dev.installer.yaml
        shell: pwsh

      - name: Commit Winget Manifests
        if: steps.sha.outputs.has_windows == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if (-not (git diff --quiet packaging/winget/)) {
            git add packaging/winget/
            git commit -m "chore(winget): update dev manifests to ${{ needs.build.outputs.dev_version }} [skip ci]"
            git push origin HEAD:experimental/multi-source-swarm
            Write-Host "âœ… Winget manifests updated and pushed"
          } else {
            Write-Host "No changes to Winget manifests"
          }
        shell: pwsh

      - name: Create PR to winget-pkgs (Manual)
        if: steps.sha.outputs.has_windows == 'true'
        run: |
          Write-Host "ðŸ“ To publish to Winget, submit a PR to microsoft/winget-pkgs:"
          Write-Host ""
          Write-Host "1. Fork https://github.com/microsoft/winget-pkgs"
          Write-Host "2. Copy manifests from packaging/winget/ to:"
          Write-Host "   manifests/s/snapetech/slskdn-dev/${{ needs.build.outputs.dev_version }}/"
          Write-Host "3. Create PR with title:"
          Write-Host "   snapetech.slskdn-dev version ${{ needs.build.outputs.dev_version }}"
          Write-Host ""
          Write-Host "Or use WingetCreate CLI:"
          Write-Host "wingetcreate update snapetech.slskdn-dev -u https://github.com/snapetech/slskdn/releases/download/dev/slskdn-dev-windows-x64.zip -v ${{ needs.build.outputs.dev_version }}"
        shell: pwsh

  copr:
    name: Publish to COPR
    runs-on: ubuntu-latest
    needs: [build, release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: experimental/multi-source-swarm

      - name: Download from Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download dev \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-linux-x64.zip"

      - name: Setup RPM Build
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip rpm
          pip3 install copr-cli
          mkdir -p ~/rpmbuild/{SOURCES,SPECS,SRPMS}

      - name: Prepare Sources
        run: |
          # Copy the built zip to SOURCES
          cp slskdn-dev-linux-x64.zip ~/rpmbuild/SOURCES/
          
          # Copy supporting files
          cp packaging/aur/slskd.service ~/rpmbuild/SOURCES/
          cp packaging/aur/slskd.yml ~/rpmbuild/SOURCES/
          cp packaging/aur/slskd.sysusers ~/rpmbuild/SOURCES/slskd.conf

      - name: Update Spec File
        run: |
          # Use the dev spec template
          cp packaging/rpm/slskdn-dev.spec ~/rpmbuild/SPECS/
          
          # Convert version for RPM (replace ALL hyphens with dots)
          # 0.24.1-dev-20251209-203936 â†’ 0.24.1.dev.20251209.203936
          RPM_VERSION=$(echo "${{ needs.build.outputs.dev_version }}" | sed 's/-/./g')
          
          # Update version
          sed -i "s/^Version:.*/Version:        ${RPM_VERSION}/" ~/rpmbuild/SPECS/slskdn-dev.spec
          
          cat ~/rpmbuild/SPECS/slskdn-dev.spec | head -30

      - name: Configure COPR
        env:
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
        run: |
          if [ -z "$COPR_LOGIN" ] || [ -z "$COPR_TOKEN" ]; then
            echo "COPR credentials not configured. Skipping."
            exit 0
          fi
          mkdir -p ~/.config
          cat > ~/.config/copr << EOF
          [copr-cli]
          login = ${COPR_LOGIN}
          username = slskdn
          token = ${COPR_TOKEN}
          copr_url = https://copr.fedorainfracloud.org
          EOF

      - name: Build SRPM
        run: |
          rpmbuild -bs ~/rpmbuild/SPECS/slskdn-dev.spec --define "_topdir $HOME/rpmbuild"
          
          SRPM=$(find ~/rpmbuild/SRPMS -name "*.src.rpm" | head -1)
          echo "Built SRPM: $SRPM"
          rpm -qpl "$SRPM" | head -20
          echo "SRPM_PATH=$SRPM" >> $GITHUB_ENV

      - name: Upload to COPR
        env:
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
        run: |
          if [ -z "$COPR_LOGIN" ] || [ -z "$COPR_TOKEN" ]; then
            echo "Skipping COPR upload - credentials not configured"
            exit 0
          fi
          
          echo "Uploading SRPM to COPR: $SRPM_PATH"
          # Upload to slskdn-dev project (separate from stable)
          copr-cli build slskdn/slskdn-dev "$SRPM_PATH" --nowait

  ppa:
    name: Publish to PPA
    runs-on: ubuntu-latest
    needs: [build, release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: experimental/multi-source-swarm

      - name: Download from Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download dev \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-linux-x64.zip"
          unzip slskdn-dev-linux-x64.zip -d publish-linux-x64

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dput gnupg build-essential

      - name: Import GPG Key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "GPG_PRIVATE_KEY secret not set. Skipping PPA upload."
            exit 0
          fi
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          # Trust the key
          KEY_ID=$(gpg --list-keys --keyid-format long | grep -A1 "^pub" | tail -1 | awk '{print $1}')
          echo "$KEY_ID:6:" | gpg --import-ownertrust

      - name: Prepare Source Structure
        run: |
          VERSION="${{ needs.build.outputs.dev_version }}"
          
          # Create proper directory structure for debian packaging
          mkdir -p slskdn-dev-${VERSION}/usr/lib/slskd
          mkdir -p slskdn-dev-${VERSION}/lib/systemd/system
          mkdir -p slskdn-dev-${VERSION}/etc/slskd
          mkdir -p slskdn-dev-${VERSION}/usr/lib/sysusers.d
          
          # Copy binary files from our build
          cp -r publish-linux-x64/* slskdn-dev-${VERSION}/usr/lib/slskd/
          
          # Copy service files from packaging
          cp packaging/aur/slskd.service slskdn-dev-${VERSION}/lib/systemd/system/
          cp packaging/aur/slskd.yml slskdn-dev-${VERSION}/etc/slskd/
          cp packaging/aur/slskd.sysusers slskdn-dev-${VERSION}/usr/lib/sysusers.d/slskd.conf

      - name: Prepare Source Package
        run: |
          VERSION="${{ needs.build.outputs.dev_version }}"
          # Convert version for Debian (replace ALL hyphens with dots)
          DEB_VERSION=$(echo "$VERSION" | sed 's/-/./g')
          
          # Create tarball for orig source
          tar -czvf slskdn-dev_${DEB_VERSION}.orig.tar.gz slskdn-dev-${VERSION}
          
          # Copy and modify debian directory for -dev package
          cp -r packaging/debian slskdn-dev-${VERSION}/
          
          # Update control file for slskdn-dev package
          cd slskdn-dev-${VERSION}
          sed -i 's/^Source: slskdn$/Source: slskdn-dev/' debian/control
          sed -i 's/^Package: slskdn$/Package: slskdn-dev/' debian/control
          sed -i 's/^Conflicts: slskd$/Conflicts: slskd, slskdn/' debian/control
          sed -i 's/^Replaces: slskd$/Replaces: slskd, slskdn/' debian/control
          sed -i 's/^Description:.*/Description: ðŸ”‹ DEV: The batteries included, ***EXPERIMENTAL*** fork of slskd. Feature-rich, including multi-source downloads, DHT mesh sync, swarm mode \& more/' debian/control
          
          # Use timestamp-based PPA revision
          PPA_REV=$(date +%Y%m%d%H%M)
          
          # Update changelog for slskdn-dev (use DEB_VERSION with dots)
          cat > debian/changelog << EOF
          slskdn-dev (${DEB_VERSION}-1ppa${PPA_REV}~jammy) jammy; urgency=medium

            * Development build from experimental/multi-source-swarm
            * Multi-source swarm downloads
            * DHT mesh network
            * BitTorrent DHT rendezvous

           -- slskdn <slskdn@proton.me>  $(date -R)
          EOF

      - name: Build Source Package
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then exit 0; fi
          
          VERSION="${{ needs.build.outputs.dev_version }}"
          cd slskdn-dev-${VERSION}
          debuild -S -sa -d -k07E2531E1F470F8008ACCFC996A07606FE65392F

      - name: Configure dput
        run: |
          cat > ~/.dput.cf << 'EOF'
          [slskdn-ppa]
          fqdn = ppa.launchpad.net
          method = ftp
          incoming = ~keefshape/ubuntu/slskdn/
          login = anonymous
          allow_unsigned_uploads = 0
          EOF

      - name: Upload to PPA
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "Skipping PPA upload - GPG_PRIVATE_KEY not configured"
            exit 0
          fi
          ls -la *.changes || true
          CHANGES_FILE=$(find . -name "slskdn-dev*.changes" -type f | head -1)
          echo "Found changes file: $CHANGES_FILE"
          dput slskdn-ppa "$CHANGES_FILE"

  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [build, release]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: experimental/multi-source-swarm

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: slskdn-dev-linux-x64

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Dev Image
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            VERSION=${{ needs.build.outputs.version }}
          tags: |
            ghcr.io/snapetech/slskdn:dev-${{ needs.build.outputs.timestamp }}
            ghcr.io/snapetech/slskdn:dev-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  packages:
    name: Build .deb Package
    runs-on: ubuntu-latest
    needs: [build, release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: experimental/multi-source-swarm

      - name: Download from Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download dev \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-linux-x64.zip"
          unzip slskdn-dev-linux-x64.zip -d slskdn-build

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper fakeroot build-essential

      - name: Prepare Package Structure
        run: |
          mkdir -p pkg/usr/lib/slskd
          mkdir -p pkg/usr/bin
          mkdir -p pkg/lib/systemd/system
          mkdir -p pkg/etc/slskd
          mkdir -p pkg/usr/lib/sysusers.d
          
          cp -r slskdn-build/* pkg/usr/lib/slskd/
          cp packaging/aur/slskd.service pkg/lib/systemd/system/
          cp packaging/aur/slskd.yml pkg/etc/slskd/
          cp packaging/aur/slskd.sysusers pkg/usr/lib/sysusers.d/slskd.conf
          
          cp -r packaging/debian pkg/

      - name: Build .deb Package
        run: |
          cd pkg
          # Convert version for Debian (replace ALL hyphens with dots)
          DEB_VERSION=$(echo "${{ needs.build.outputs.dev_version }}" | sed 's/-/./g')
          sed -i "s/slskdn (.*)/slskdn-dev (${DEB_VERSION}-1) unstable; urgency=medium/" debian/changelog
          sed -i "s/^Source: slskdn$/Source: slskdn-dev/" debian/control
          sed -i "s/^Package: slskdn$/Package: slskdn-dev/" debian/control
          dpkg-buildpackage -us -uc -b
          cd ..
          DEB_FILE="slskdn-dev_${DEB_VERSION}_amd64.deb"
          mv *.deb "$DEB_FILE"
          echo "DEB_FILE=$DEB_FILE" >> $GITHUB_ENV
          ls -lh "$DEB_FILE"

      - name: Upload .deb to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: dev
          files: ${{ env.DEB_FILE }}

  snap:
    name: Publish to Snap (Edge)
    runs-on: ubuntu-latest
    needs: [build, release]
    steps:
      - uses: actions/checkout@v4
        with: { ref: experimental/multi-source-swarm }
      
      - name: Download from Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download dev \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-linux-x64.zip"
      
      - name: Build and Push
        env: { SNAPCRAFT_STORE_CREDENTIALS: "${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}" }
        if: "${{ env.SNAPCRAFT_STORE_CREDENTIALS != '' }}"
        run: |
          unzip slskdn-dev-linux-x64.zip -d slskdn_dist
          sed -i "s|source: .*|source: slskdn_dist|" packaging/snap/snapcraft.yaml
          sed -i "/source-checksum:/d" packaging/snap/snapcraft.yaml
          sed -i "s|version: .*|version: '${{ needs.build.outputs.dev_version }}'|" packaging/snap/snapcraft.yaml
          sed -i "s|grade: stable|grade: devel|" packaging/snap/snapcraft.yaml
          sudo snap install snapcraft --classic
          cd packaging/snap && snapcraft
          echo "$SNAPCRAFT_STORE_CREDENTIALS" > snap.login
          snapcraft login --with snap.login
          snapcraft upload --release=edge *.snap

  chocolatey:
    name: Publish to Chocolatey (Pre)
    runs-on: windows-latest
    needs: [build, release]
    steps:
      - uses: actions/checkout@v4
        with: { ref: experimental/multi-source-swarm }
      
      - name: Download from Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download dev `
            --repo ${{ github.repository }} `
            --pattern "slskdn-dev-win-x64.zip"
      
      - name: Pack and Push
        env: { CHOCO_API_KEY: "${{ secrets.CHOCO_API_KEY }}" }
        if: "${{ env.CHOCO_API_KEY != '' }}"
        run: |
          $Version = "${{ needs.build.outputs.dev_version }}"
          $Url = "https://github.com/${{ github.repository }}/releases/download/dev/slskdn-dev-win-x64.zip"
          $Checksum = (Get-FileHash slskdn-dev-win-x64.zip -Algorithm SHA256).Hash
          (Get-Content packaging/chocolatey/slskdn.nuspec) -replace '<version>.*</version>', "<version>$Version</version>" | Set-Content packaging/chocolatey/slskdn.nuspec
          (Get-Content packaging/chocolatey/tools/chocolateyinstall.ps1) -replace '\$url\s*=\s*".*"', "`$url = `"$Url`"" | Set-Content packaging/chocolatey/tools/chocolateyinstall.ps1
          (Get-Content packaging/chocolatey/tools/chocolateyinstall.ps1) -replace '\$checksum\s*=\s*".*"', "`$checksum = `"$Checksum`"" | Set-Content packaging/chocolatey/tools/chocolateyinstall.ps1
          cd packaging/chocolatey
          choco pack
          choco push --source https://push.chocolatey.org/ --api-key $env:CHOCO_API_KEY

  homebrew:
    name: Update Homebrew Tap (Dev)
    runs-on: ubuntu-latest
    needs: [build, release]
    steps:
      - name: Download from Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download dev \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-*.zip"
        
      - name: Update Tap
        env: { GH_TOKEN: "${{ secrets.TAP_GITHUB_TOKEN }}" }
        if: "${{ env.GH_TOKEN != '' }}"
        run: |
          SHA_MAC_X64=$(sha256sum slskdn-dev-osx-x64.zip | cut -d' ' -f1)
          SHA_MAC_ARM=$(sha256sum slskdn-dev-osx-arm64.zip | cut -d' ' -f1)
          SHA_LINUX=$(sha256sum slskdn-dev-linux-x64.zip | cut -d' ' -f1)
          VERSION="${{ needs.build.outputs.dev_version }}"
          git clone https://x-access-token:${GH_TOKEN}@github.com/snapetech/homebrew-slskdn.git tap
          cd tap
          cat > Formula/slskdn-dev.rb <<EOF
          class SlskdnDev < Formula
            desc "Batteries-included Soulseek web client (Development Build)"
            homepage "https://github.com/snapetech/slskdn"
            license "AGPL-3.0-or-later"
            version "${VERSION}"
            url "https://github.com/snapetech/slskdn/releases/download/dev/slskdn-dev-linux-x64.zip"
            sha256 "${SHA_LINUX}"
            on_macos do
              on_arm do
                url "https://github.com/snapetech/slskdn/releases/download/dev/slskdn-dev-osx-arm64.zip"
                sha256 "${SHA_MAC_ARM}"
              end
              on_intel do
                url "https://github.com/snapetech/slskdn/releases/download/dev/slskdn-dev-osx-x64.zip"
                sha256 "${SHA_MAC_X64}"
              end
            end
            on_linux do
              url "https://github.com/snapetech/slskdn/releases/download/dev/slskdn-dev-linux-x64.zip"
              sha256 "${SHA_LINUX}"
            end
            conflicts_with "slskdn", because: "both install slskdn binary"
            def install
              libexec.install Dir["*"]
              (bin/"slskdn-dev").write_exec_script libexec/"slskd"
            end
          end
          EOF
          git config user.name "slskdn CI" && git config user.email "slskdn@proton.me"
          git add Formula/slskdn-dev.rb
          git commit -m "Update slskdn-dev to $VERSION" || echo "No changes"
          git push

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [build, release, aur, copr, ppa, docker, packages, nix, winget, snap, chocolatey, homebrew]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Dev Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ needs.build.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Status" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release: ${{ needs.release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- AUR (slskdn-dev): ${{ needs.aur.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- COPR (slskdn-dev): ${{ needs.copr.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- PPA (slskdn-dev): ${{ needs.ppa.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: ${{ needs.docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Packages (.deb/.rpm): ${{ needs.packages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Nix Flake: ${{ needs.nix.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Winget: ${{ needs.winget.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Snap (Edge): ${{ needs.snap.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Chocolatey (Pre): ${{ needs.chocolatey.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Homebrew Tap: ${{ needs.homebrew.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Arch Linux (AUR)" >> $GITHUB_STEP_SUMMARY
          echo "yay -S slskdn-dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Fedora/RHEL (COPR)" >> $GITHUB_STEP_SUMMARY
          echo "sudo dnf copr enable slskdn/slskdn-dev" >> $GITHUB_STEP_SUMMARY
          echo "sudo dnf install slskdn-dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Docker" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/snapetech/slskdn:dev-latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Ubuntu/Debian (PPA)" >> $GITHUB_STEP_SUMMARY
          echo "sudo add-apt-repository ppa:keefshape/slskdn" >> $GITHUB_STEP_SUMMARY
          echo "sudo apt update" >> $GITHUB_STEP_SUMMARY
          echo "sudo apt install slskdn-dev" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY


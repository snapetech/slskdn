name: Dev Release (AUR + COPR)

# Build and push -dev packages only when explicitly tagged
on:
  push:
    tags:
      - 'dev-*'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no changes'
        required: false
        default: 'false'

env:
  DOTNET_VERSION: '8'
  BASE_VERSION: '0.24.1'

jobs:
  build:
    name: Build Dev Release
    runs-on: ${{ vars.PREFER_SELF_HOSTED != 'false' && 'self-hosted' || 'ubuntu-latest' }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      dev_version: ${{ steps.version.outputs.dev_version }}
      short_sha: ${{ steps.version.outputs.short_sha }}
      timestamp: ${{ steps.version.outputs.timestamp }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up .NET (GitHub-hosted)
        if: ${{ !contains(runner.name, 'keith') }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Verify .NET (self-hosted)
        if: ${{ contains(runner.name, 'keith') }}
        run: dotnet --version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/web/package-lock.json

      - name: Set Version
        id: version
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
          # Version format: 0.24.1-dev-YYYYMMDD-HHMMSS (tag format)
          # For NuGet/PKGBUILD: replace hyphens in timestamp portion
          DEV_VERSION="${BASE_VERSION}-dev-${TIMESTAMP}"
          
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "dev_version=${DEV_VERSION}" >> $GITHUB_OUTPUT
          echo "version=${DEV_VERSION}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "VERSION=${DEV_VERSION}" >> $GITHUB_ENV
          
          echo "ðŸ“¦ Building version: ${DEV_VERSION} (commit: ${SHORT_SHA})"

      - name: Build Frontend
        working-directory: src/web
        run: |
          npm ci
          DISABLE_ESLINT_PLUGIN=true npm run build

      - name: Build Backend
        run: |
          dotnet publish src/slskd/slskd.csproj \
            -c Release \
            -o publish-linux-x64 \
            --self-contained true \
            -r linux-x64 \
            /p:Version=${{ env.VERSION }}

      - name: Copy Web Assets
        run: |
          cp -r src/web/build/* publish-linux-x64/wwwroot/

      - name: Create Release Archive
        run: |
          cd publish-linux-x64
          zip -r ../slskdn-dev-linux-x64.zip .
          cd ..
          ls -lh slskdn-dev-linux-x64.zip

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: slskdn-dev-linux-x64
          path: slskdn-dev-linux-x64.zip
          retention-days: 30

  release:
    name: Create Dev Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: slskdn-dev-linux-x64

      - name: Delete Previous Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete the old dev release if it exists
          gh release delete dev --yes --repo ${{ github.repository }} 2>/dev/null || true
          git push origin :refs/tags/dev 2>/dev/null || true

      - name: Create Dev Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: dev
          name: "ðŸ§ª Development Build"
          body: |
            ## Development Build
            
            **Version:** ${{ needs.build.outputs.version }}
            **Branch:** experimental/multi-source-swarm
            **Commit:** ${{ needs.build.outputs.short_sha }}
            **Built:** ${{ github.event.head_commit.timestamp }}
            
            ### âš ï¸ Warning
            This is an **unstable development build** from the experimental branch.
            It includes cutting-edge features that may contain bugs.
            
            ### Features in this build:
            - ðŸ”€ **Multi-source swarm downloads** - Download from multiple peers simultaneously
            - ðŸŒ **DHT mesh network** - Distributed hash table for content verification
            - ðŸ”— **BitTorrent DHT rendezvous** - Peer discovery via mainline DHT
            - ðŸ”’ **TLS overlay protocol** - Secure mesh connections
            - ðŸ“Š **Hash database** - Local SQLite with mesh sync
            
            ### Install
            ```bash
            # Arch Linux (AUR)
            yay -S slskdn-dev
            
            # Fedora/RHEL (COPR)
            sudo dnf copr enable slskdn/slskdn-dev
            sudo dnf install slskdn-dev
            
            # Ubuntu/Debian (PPA)
            sudo add-apt-repository ppa:keefshape/slskdn
            sudo apt update
            sudo apt install slskdn-dev
            ```
          prerelease: true
          files: slskdn-dev-linux-x64.zip

  aur:
    name: Publish to AUR
    runs-on: ubuntu-latest
    needs: [build, release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: experimental/multi-source-swarm

      - name: Download from Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Download from the dev release we just created
          gh release download dev \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-linux-x64.zip"

      - name: Calculate SHA256
        id: sha
        run: |
          SHA256=$(sha256sum slskdn-dev-linux-x64.zip | cut -d' ' -f1)
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          echo "SHA256: ${SHA256}"

      - name: Setup SSH for AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then
            echo "AUR_SSH_KEY not configured, skipping AUR publish"
            exit 0
          fi
          
          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          
          cat >> ~/.ssh/config << EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
          EOF
          
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts

      - name: Clone AUR Package
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then exit 0; fi
          
          git clone ssh://aur@aur.archlinux.org/slskdn-dev.git aur-pkg || {
            # If package doesn't exist yet, create it
            mkdir -p aur-pkg
            cd aur-pkg
            git init
            git remote add origin ssh://aur@aur.archlinux.org/slskdn-dev.git
          }

      - name: Update PKGBUILD
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then exit 0; fi
          
          cd aur-pkg
          
          # Copy the dev PKGBUILD template and install file
          cp ../packaging/aur/PKGBUILD-dev PKGBUILD
          cp ../packaging/aur/slskd.install slskd.install
          
          # Convert version for Arch (replace ALL hyphens with dots)
          # 0.24.1-dev-20251209-203936 â†’ 0.24.1.dev.20251209.203936
          ARCH_VERSION=$(echo "${{ needs.build.outputs.dev_version }}" | sed 's/-/./g')
          
          # Update version and commit (keep sha256sums as-is with SKIP for the zip)
          sed -i "s/^pkgver=.*/pkgver=${ARCH_VERSION}/" PKGBUILD
          sed -i "s/^_commit=.*/_commit=${{ needs.build.outputs.short_sha }}/" PKGBUILD
          
          # Generate .SRCINFO
          docker run --rm -v "$PWD:/pkg" -w /pkg archlinux:base-devel bash -c "
            pacman -Sy --noconfirm pacman-contrib
            useradd -m builder
            chown -R builder:builder /pkg
            su builder -c 'makepkg --printsrcinfo' > .SRCINFO
          "
          
          # Fix ownership after docker (docker runs as root and changes permissions)
          sudo chown -R $(id -u):$(id -g) .
          
          cat PKGBUILD
          cat .SRCINFO

      - name: Push to AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [ -z "$AUR_SSH_KEY" ]; then
            echo "Skipping AUR push - credentials not configured"
            exit 0
          fi
          
          cd aur-pkg
          git config user.name "slskdn CI"
          git config user.email "slskdn@proton.me"
          git add PKGBUILD .SRCINFO slskd.install
          git commit -m "Update to ${{ needs.build.outputs.dev_version }}" || echo "No changes to commit"
          git push origin master || git push --set-upstream origin master

  copr:
    name: Publish to COPR
    runs-on: ubuntu-latest
    needs: [build, release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: experimental/multi-source-swarm

      - name: Download from Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download dev \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-linux-x64.zip"

      - name: Setup RPM Build
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip rpm
          pip3 install copr-cli
          mkdir -p ~/rpmbuild/{SOURCES,SPECS,SRPMS}

      - name: Prepare Sources
        run: |
          # Copy the built zip to SOURCES
          cp slskdn-dev-linux-x64.zip ~/rpmbuild/SOURCES/
          
          # Copy supporting files
          cp packaging/aur/slskd.service ~/rpmbuild/SOURCES/
          cp packaging/aur/slskd.yml ~/rpmbuild/SOURCES/
          cp packaging/aur/slskd.sysusers ~/rpmbuild/SOURCES/slskd.conf

      - name: Update Spec File
        run: |
          # Use the dev spec template
          cp packaging/rpm/slskdn-dev.spec ~/rpmbuild/SPECS/
          
          # Convert version for RPM (replace ALL hyphens with dots)
          # 0.24.1-dev-20251209-203936 â†’ 0.24.1.dev.20251209.203936
          RPM_VERSION=$(echo "${{ needs.build.outputs.dev_version }}" | sed 's/-/./g')
          
          # Update version
          sed -i "s/^Version:.*/Version:        ${RPM_VERSION}/" ~/rpmbuild/SPECS/slskdn-dev.spec
          
          cat ~/rpmbuild/SPECS/slskdn-dev.spec | head -30

      - name: Configure COPR
        env:
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
        run: |
          if [ -z "$COPR_LOGIN" ] || [ -z "$COPR_TOKEN" ]; then
            echo "COPR credentials not configured. Skipping."
            exit 0
          fi
          mkdir -p ~/.config
          cat > ~/.config/copr << EOF
          [copr-cli]
          login = ${COPR_LOGIN}
          username = slskdn
          token = ${COPR_TOKEN}
          copr_url = https://copr.fedorainfracloud.org
          EOF

      - name: Build SRPM
        run: |
          rpmbuild -bs ~/rpmbuild/SPECS/slskdn-dev.spec --define "_topdir $HOME/rpmbuild"
          
          SRPM=$(find ~/rpmbuild/SRPMS -name "*.src.rpm" | head -1)
          echo "Built SRPM: $SRPM"
          rpm -qpl "$SRPM" | head -20
          echo "SRPM_PATH=$SRPM" >> $GITHUB_ENV

      - name: Upload to COPR
        env:
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
        run: |
          if [ -z "$COPR_LOGIN" ] || [ -z "$COPR_TOKEN" ]; then
            echo "Skipping COPR upload - credentials not configured"
            exit 0
          fi
          
          echo "Uploading SRPM to COPR: $SRPM_PATH"
          # Upload to slskdn-dev project (separate from stable)
          copr-cli build slskdn/slskdn-dev "$SRPM_PATH" --nowait

  ppa:
    name: Publish to PPA
    runs-on: ubuntu-latest
    needs: [build, release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: experimental/multi-source-swarm

      - name: Download from Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download dev \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-linux-x64.zip"
          unzip slskdn-dev-linux-x64.zip -d publish-linux-x64

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dput gnupg build-essential

      - name: Import GPG Key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "GPG_PRIVATE_KEY secret not set. Skipping PPA upload."
            exit 0
          fi
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          # Trust the key
          KEY_ID=$(gpg --list-keys --keyid-format long | grep -A1 "^pub" | tail -1 | awk '{print $1}')
          echo "$KEY_ID:6:" | gpg --import-ownertrust

      - name: Prepare Source Structure
        run: |
          VERSION="${{ needs.build.outputs.dev_version }}"
          
          # Create proper directory structure for debian packaging
          mkdir -p slskdn-dev-${VERSION}/usr/lib/slskd
          mkdir -p slskdn-dev-${VERSION}/lib/systemd/system
          mkdir -p slskdn-dev-${VERSION}/etc/slskd
          mkdir -p slskdn-dev-${VERSION}/usr/lib/sysusers.d
          
          # Copy binary files from our build
          cp -r publish-linux-x64/* slskdn-dev-${VERSION}/usr/lib/slskd/
          
          # Copy service files from packaging
          cp packaging/aur/slskd.service slskdn-dev-${VERSION}/lib/systemd/system/
          cp packaging/aur/slskd.yml slskdn-dev-${VERSION}/etc/slskd/
          cp packaging/aur/slskd.sysusers slskdn-dev-${VERSION}/usr/lib/sysusers.d/slskd.conf

      - name: Prepare Source Package
        run: |
          VERSION="${{ needs.build.outputs.dev_version }}"
          # Convert version for Debian (replace ALL hyphens with dots)
          DEB_VERSION=$(echo "$VERSION" | sed 's/-/./g')
          
          # Create tarball for orig source
          tar -czvf slskdn-dev_${DEB_VERSION}.orig.tar.gz slskdn-dev-${VERSION}
          
          # Copy and modify debian directory for -dev package
          cp -r packaging/debian slskdn-dev-${VERSION}/
          
          # Update control file for slskdn-dev package
          cd slskdn-dev-${VERSION}
          sed -i 's/^Source: slskdn$/Source: slskdn-dev/' debian/control
          sed -i 's/^Package: slskdn$/Package: slskdn-dev/' debian/control
          sed -i 's/^Conflicts: slskd$/Conflicts: slskd, slskdn/' debian/control
          sed -i 's/^Replaces: slskd$/Replaces: slskd, slskdn/' debian/control
          sed -i 's/^Description:.*/Description: ðŸ”‹ DEV: The batteries included, ***EXPERIMENTAL*** fork of slskd. Feature-rich, including multi-source downloads, DHT mesh sync, swarm mode \& more/' debian/control
          
          # Use timestamp-based PPA revision
          PPA_REV=$(date +%Y%m%d%H%M)
          
          # Update changelog for slskdn-dev (use DEB_VERSION with dots)
          cat > debian/changelog << EOF
          slskdn-dev (${DEB_VERSION}-1ppa${PPA_REV}~jammy) jammy; urgency=medium

            * Development build from experimental/multi-source-swarm
            * Multi-source swarm downloads
            * DHT mesh network
            * BitTorrent DHT rendezvous

           -- slskdn <slskdn@proton.me>  $(date -R)
          EOF

      - name: Build Source Package
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then exit 0; fi
          
          VERSION="${{ needs.build.outputs.dev_version }}"
          cd slskdn-dev-${VERSION}
          debuild -S -sa -d -k07E2531E1F470F8008ACCFC996A07606FE65392F

      - name: Configure dput
        run: |
          cat > ~/.dput.cf << 'EOF'
          [slskdn-ppa]
          fqdn = ppa.launchpad.net
          method = ftp
          incoming = ~keefshape/ubuntu/slskdn/
          login = anonymous
          allow_unsigned_uploads = 0
          EOF

      - name: Upload to PPA
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "Skipping PPA upload - GPG_PRIVATE_KEY not configured"
            exit 0
          fi
          ls -la *.changes || true
          CHANGES_FILE=$(find . -name "slskdn-dev*.changes" -type f | head -1)
          echo "Found changes file: $CHANGES_FILE"
          dput slskdn-ppa "$CHANGES_FILE"

  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [build, release]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: experimental/multi-source-swarm

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: slskdn-dev-linux-x64

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Dev Image
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            VERSION=${{ needs.build.outputs.version }}
          tags: |
            ghcr.io/snapetech/slskdn:dev-${{ needs.build.outputs.timestamp }}
            ghcr.io/snapetech/slskdn:dev-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  packages:
    name: Build .deb Package
    runs-on: ubuntu-latest
    needs: [build, release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: experimental/multi-source-swarm

      - name: Download from Dev Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download dev \
            --repo ${{ github.repository }} \
            --pattern "slskdn-dev-linux-x64.zip"
          unzip slskdn-dev-linux-x64.zip -d slskdn-build

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper fakeroot build-essential

      - name: Prepare Package Structure
        run: |
          mkdir -p pkg/usr/lib/slskd
          mkdir -p pkg/usr/bin
          mkdir -p pkg/lib/systemd/system
          mkdir -p pkg/etc/slskd
          mkdir -p pkg/usr/lib/sysusers.d
          
          cp -r slskdn-build/* pkg/usr/lib/slskd/
          cp packaging/aur/slskd.service pkg/lib/systemd/system/
          cp packaging/aur/slskd.yml pkg/etc/slskd/
          cp packaging/aur/slskd.sysusers pkg/usr/lib/sysusers.d/slskd.conf
          
          cp -r packaging/debian pkg/

      - name: Build .deb Package
        run: |
          cd pkg
          # Convert version for Debian (replace ALL hyphens with dots)
          DEB_VERSION=$(echo "${{ needs.build.outputs.dev_version }}" | sed 's/-/./g')
          sed -i "s/slskdn (.*)/slskdn-dev (${DEB_VERSION}-1) unstable; urgency=medium/" debian/changelog
          sed -i "s/^Source: slskdn$/Source: slskdn-dev/" debian/control
          sed -i "s/^Package: slskdn$/Package: slskdn-dev/" debian/control
          dpkg-buildpackage -us -uc -b
          cd ..
          DEB_FILE="slskdn-dev_${DEB_VERSION}_amd64.deb"
          mv *.deb "$DEB_FILE"
          echo "DEB_FILE=$DEB_FILE" >> $GITHUB_ENV
          ls -lh "$DEB_FILE"

      - name: Upload .deb to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: dev
          files: ${{ env.DEB_FILE }}

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [build, release, aur, copr, ppa, docker, packages]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Dev Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ needs.build.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Status" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release: ${{ needs.release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- AUR (slskdn-dev): ${{ needs.aur.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- COPR (slskdn-dev): ${{ needs.copr.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- PPA (slskdn-dev): ${{ needs.ppa.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: ${{ needs.docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Packages (.deb/.rpm): ${{ needs.packages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Arch Linux (AUR)" >> $GITHUB_STEP_SUMMARY
          echo "yay -S slskdn-dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Fedora/RHEL (COPR)" >> $GITHUB_STEP_SUMMARY
          echo "sudo dnf copr enable slskdn/slskdn-dev" >> $GITHUB_STEP_SUMMARY
          echo "sudo dnf install slskdn-dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Docker" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/snapetech/slskdn:dev-latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Ubuntu/Debian (PPA)" >> $GITHUB_STEP_SUMMARY
          echo "sudo add-apt-repository ppa:keefshape/slskdn" >> $GITHUB_STEP_SUMMARY
          echo "sudo apt update" >> $GITHUB_STEP_SUMMARY
          echo "sudo apt install slskdn-dev" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY


#!/bin/bash
set -e

web_only=false
dotnet_only=false
skip_tests=false

while test $# -gt 0; do
  case "$1" in
    -h|--help)
      echo 'options:'
      echo '-h, --help          show help'
      echo '--web-only          skip dotnet build'
      echo '--dotnet-only       skip web build'
      echo '--skip-tests        skip execution of npm and dotnet tests'
      echo '--version           version for the binary. defaults to current git tag+SHA'
      echo ''
      echo 'Note: Protocol contract tests require Soulfind server simulator.'
      echo '      If Docker is available, the build script will attempt to pull'
      echo '      the Soulfind image. Tests will skip gracefully if unavailable.'
      echo '      See docs/dev/SOULFIND_CI_INTEGRATION.md for details.'
      exit 0
      ;;
    --web-only)
      web_only=true
      shift
      ;;
    --dotnet-only)
      dotnet_only=true
      shift
      ;;
    --skip-tests)
      skip_tests=true
      shift
      ;;
    --version)
      shift
      version=$1
      shift
      ;;
    *)
      break
      ;;
  esac
done

if [ -z "$version" ]; then
  tag=$(git describe --tags --abbrev=0)
  sha=$(git rev-parse --short HEAD)
  # .NET/NuGet version: no "build-*" prefix, use hyphen prerelease (e.g. 0.24.1-dev-123), no "+" metadata
  if [[ "$tag" == build-dev-* ]]; then
    version="${tag#build-dev-}"
    version="${version//.dev./-dev-}"
  elif [[ "$tag" == build-main-* ]]; then
    version="${tag#build-main-}"
  else
    version="${tag}"
    [[ "$version" == *"+"* ]] && version="${version//+/.}"
  fi
fi

if [ "$dotnet_only" == true ]; then
  echo $'\n\tâ©  web build skipped\n'
else 
  # build web
  cd src/web
  echo $'\n\tğŸ“  '$(pwd)$'\n'

  echo $'\n\tğŸ› ï¸  npm ci --legacy-peer-deps\n'
  npm ci --legacy-peer-deps

  if [ "$skip_tests" == true ]; then
      echo $'\n\tâ©  web tests skipped\n'
  else
      echo $'\n\tğŸ§ª  npm run test-unattended\n'
      npm run test-unattended
  fi

  echo $'\n\tğŸ› ï¸  npm run build\n'
  npm run build

  if [ "$web_only" == false ]; then
    # remove old build, but keep .gitkeep
    rm -rf ../slskd/wwwroot
    mkdir ../slskd/wwwroot
    touch ../slskd/wwwroot/.gitkeep

    # copy new files
    echo $'\n\tğŸ› ï¸  cp -r build/* ../slskd/wwwroot/\n'
    cp -r build/* ../slskd/wwwroot/
  fi
  
  cd ../..
fi

if [ "$web_only" == true ]; then
    echo $'\n\tâ©  dotnet build skipped\n'
else
    # build api + web
    cd src/slskd
    echo $'\n\tğŸ“ '$(pwd)$'\n'

    echo $'\n\tğŸ› ï¸  dotnet build --no-incremental --nologo --configuration Release -p:Version '$version$'\n'
    dotnet build --no-incremental --nologo --configuration Release -p:Version=$version

    if [ "$skip_tests" == true ]; then
        echo $'\n\tâ©  dotnet tests skipped\n'
    else
        # Optional: Setup Soulfind for protocol contract tests (if Docker available)
        if command -v docker &> /dev/null; then
            echo $'\n\tğŸ³  Checking for Soulfind Docker image (optional, for protocol tests)...\n'
            docker pull ghcr.io/soulfind-dev/soulfind:latest 2>/dev/null || echo $'   âš ï¸  Soulfind image not available - protocol tests will skip gracefully\n'
        fi

        echo $'\n\tğŸ§ª  dotnet test --configuration Release ../../tests/slskd.Tests.Unit\n'
        dotnet test --configuration Release ../../tests/slskd.Tests.Unit

        echo $'\n\tğŸ§ª  dotnet test --configuration Release ../../tests/slskd.Tests\n'
        dotnet test --configuration Release ../../tests/slskd.Tests

        echo $'\n\tğŸ§ª  dotnet test --configuration Release ../../tests/slskd.Tests.Integration\n'
        dotnet test --configuration Release ../../tests/slskd.Tests.Integration
    fi
fi

echo $'\n\tğŸ‰  build succeded!\n'
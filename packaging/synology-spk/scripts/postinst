#!/bin/sh

# slskdN post-installation script for Synology Package Center
# This script runs after package installation

# Exit on any error
set -e

# Source common functions
. "$(dirname "$0")"/common

log_step "slskdN post-installation started"

# Set up package directories
create_directory "$SHARE_PATH" "$PACKAGE_USER" "$PACKAGE_GROUP"
create_directory "$SHARE_PATH/shared" "$PACKAGE_USER" "$PACKAGE_GROUP"
create_directory "$SHARE_PATH/downloads" "$PACKAGE_USER" "$PACKAGE_GROUP"
create_directory "$SHARE_PATH/incomplete" "$PACKAGE_USER" "$PACKAGE_GROUP"
create_directory "$SHARE_PATH/config" "$PACKAGE_USER" "$PACKAGE_GROUP"

# Set proper permissions
chmod 755 "$SHARE_PATH"
chmod 755 "$SHARE_PATH/shared"
chmod 755 "$SHARE_PATH/downloads"
chmod 755 "$SHARE_PATH/incomplete"
chmod 700 "$SHARE_PATH/config"  # Config should be private

# Generate default configuration
CONFIG_FILE="$SHARE_PATH/config/slskd.yml"
if [ ! -f "$CONFIG_FILE" ]; then
    log_step "Creating default configuration..."

    cat > "$CONFIG_FILE" << EOF
# slskdN Configuration (Generated by Synology Package)
# Edit this file to customize your slskdN installation

# Web UI settings
web:
  enabled: true
  port: 5030
  https:
    disabled: true

# Soulseek network settings
soulseek:
  listen:
    port: 2234

# Data directories
directories:
  shared: "$SHARE_PATH/shared"
  downloads: "$SHARE_PATH/downloads"
  incomplete: "$SHARE_PATH/incomplete"

# Logging
logger:
  level: info

# VPN & Mesh Networking Features
# podcore:
#   enabled: false
#   peerId: ""

# mesh:
#   enabled: false
#   networkName: ""
#   networkPassword: ""

# transports:
#   tor:
#     enabled: false
#   i2p:
#     enabled: false
#   relay:
#     enabled: false

# privacy:
#   enabled: false
#   messagePadding: false
#   timingObfuscation: false
#   messageBatching: false

# Synology-specific settings
# Adjust these paths as needed for your Synology setup
EOF

    chown "$PACKAGE_USER:$PACKAGE_GROUP" "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"
fi

# Create systemd service override if needed
SERVICE_FILE="/usr/local/etc/rc.d/slskdn.sh"
if [ ! -f "$SERVICE_FILE" ]; then
    log_step "Creating service startup script..."

    cat > "$SERVICE_FILE" << 'EOF'
#!/bin/sh

# slskdN service script for Synology
# Generated by postinst script

case "$1" in
    start)
        echo "Starting slskdN..."
        cd /var/packages/slskdn/target
        ./dotnet/dotnet slskd.dll --config /var/packages/slskdn/shares/slskdn/config/slskd.yml &
        echo $! > /var/packages/slskdn/var/slskdn.pid
        ;;
    stop)
        echo "Stopping slskdN..."
        if [ -f /var/packages/slskdn/var/slskdn.pid ]; then
            kill $(cat /var/packages/slskdn/var/slskdn.pid)
            rm -f /var/packages/slskdn/var/slskdn.pid
        fi
        ;;
    status)
        if [ -f /var/packages/slskdn/var/slskdn.pid ] && kill -0 $(cat /var/packages/slskdn/var/slskdn.pid) 2>/dev/null; then
            echo "slskdN is running"
            exit 0
        else
            echo "slskdN is not running"
            exit 1
        fi
        ;;
    *)
        echo "Usage: $0 {start|stop|status}"
        exit 1
        ;;
esac
EOF

    chmod +x "$SERVICE_FILE"
fi

# Set up firewall rules if firewall is enabled
if synofirewall --status >/dev/null 2>&1; then
    log_step "Setting up firewall rules..."

    # Allow web UI port
    synofirewall --add-rule packages slskdn tcp 5030 5030

    # Allow Soulseek port
    synofirewall --add-rule packages slskdn tcp 2234 2234
fi

# Register package with DSM
log_step "Registering package with DSM..."

# Create desktop shortcut (optional)
DESKTOP_FILE="/usr/syno/synoman/webman/3rdparty/slskdn"
mkdir -p "$(dirname "$DESKTOP_FILE")"

cat > "$DESKTOP_FILE" << EOF
{
    "title": "slskdN",
    "desc": "Soulseek Network Client - Next Generation",
    "icon": "images/slskdn-{0}.png",
    "type": "url",
    "url": "/webman/3rdparty/slskdn/",
    "urlOpenType": "openUrl",
    "openWith": "iframe",
    "adminOnly": false
}
EOF

log_step "Post-installation completed successfully"
log_step ""
log_step "slskdN has been installed!"
log_step ""
log_step "ðŸ“ Configuration: $CONFIG_FILE"
log_step "ðŸ“ Shared files: $SHARE_PATH/shared"
log_step "ðŸ“ Downloads: $SHARE_PATH/downloads"
log_step ""
log_step "ðŸŒ Web UI: http://your-synology-ip:5030"
log_step ""
log_step "ðŸš€ To start: Package Center â†’ Installed â†’ slskdN â†’ Run"
log_step ""
log_step "ðŸ”’ VPN Features Available:"
log_step "   â€¢ Pod-scoped private networking"
log_step "   â€¢ Mesh overlay for peer discovery"
log_step "   â€¢ Tor/I2P anonymous transports"
log_step "   â€¢ Traffic analysis protection"
log_step ""
log_step "ðŸ“– Documentation: https://github.com/slskd/slskd/wiki"
log_step "ðŸ†• VPN Guide: https://github.com/slskd/slskdn/docs/pod-vpn/"

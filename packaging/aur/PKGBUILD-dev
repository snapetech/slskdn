# Maintainer: snapetech <slskdn@proton.me>
# ðŸ§ª slskdn-dev - Development build of the batteries-included Soulseek web client
# Tracks the experimental/multi-source-swarm branch with multi-source downloads & DHT mesh
pkgname=slskdn-dev
_pkgname=slskd
pkgver=0.24.1.dev.202412080000
_commit=HEAD
pkgrel=1
pkgdesc="ðŸ”‹ The batteries included fork of slskd with 24+ new features: decentralized pods, content validation, swarm downloads, DHT mesh networking, auto-replace, wishlist, security hardening. [EXPERIMENTAL]"
arch=('x86_64')
url="https://github.com/snapetech/slskdn/tree/experimental/multi-source-swarm"
license=('AGPL-3.0-or-later')
depends=()  # Self-contained build, no runtime deps
optdepends=(
    'docker: for containerized deployment'
)
provides=('slskd' 'slskdn')
conflicts=('slskd' 'slskd-bin' 'slskdn' 'slskdn-bin')
backup=('etc/slskd/slskd.yml')
install=slskd.install
source=(
    "slskdn-dev-linux-x64.zip::https://github.com/snapetech/slskdn/releases/download/RELEASE_TAG_PLACEHOLDER/slskdn-dev-linux-x64.zip"
    "slskd.service::https://github.com/snapetech/slskdn/releases/download/RELEASE_TAG_PLACEHOLDER/slskd.service"
    "slskd.yml::https://github.com/snapetech/slskdn/releases/download/RELEASE_TAG_PLACEHOLDER/slskd.yml"
    "slskd.sysusers::https://github.com/snapetech/slskdn/releases/download/RELEASE_TAG_PLACEHOLDER/slskd.sysusers"
)
# CI replaces SHA256SUM_PLACEHOLDERs with hashes of files at release tag
sha256sums=('SKIP' 'SHA256_SERVICE_PLACEHOLDER' 'SHA256_YML_PLACEHOLDER' 'SHA256_SYSUSERS_PLACEHOLDER')

package() {
    # Install application to /usr/lib/slskd
    install -dm755 "${pkgdir}/usr/lib/${_pkgname}"
    cp -r "${srcdir}"/* "${pkgdir}/usr/lib/${_pkgname}/"
    
    # Remove non-application files that were extracted
    rm -f "${pkgdir}/usr/lib/${_pkgname}/slskd.service"
    rm -f "${pkgdir}/usr/lib/${_pkgname}/slskd.yml"
    rm -f "${pkgdir}/usr/lib/${_pkgname}/slskd.sysusers"
    
    # Make binary executable
    chmod +x "${pkgdir}/usr/lib/${_pkgname}/slskd"
    
    # Create symlink /usr/bin/slskd -> /usr/lib/slskd/slskd
    install -dm755 "${pkgdir}/usr/bin"
    ln -sf "/usr/lib/${_pkgname}/slskd" "${pkgdir}/usr/bin/${_pkgname}"
    
    # Install systemd service
    install -Dm644 "${srcdir}/slskd.service" "${pkgdir}/usr/lib/systemd/system/${_pkgname}.service"
    
    # Install sysusers config
    install -Dm644 "${srcdir}/slskd.sysusers" "${pkgdir}/usr/lib/sysusers.d/${_pkgname}.conf"
    
    # Install default config
    install -Dm644 "${srcdir}/slskd.yml" "${pkgdir}/etc/${_pkgname}/${_pkgname}.yml"
    
    # Create data directories
    install -dm755 "${pkgdir}/var/lib/${_pkgname}"
    install -dm755 "${pkgdir}/var/lib/${_pkgname}/downloads"
    install -dm755 "${pkgdir}/var/lib/${_pkgname}/incomplete"
}


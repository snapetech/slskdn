app-id: io.github.slskd.slskdn
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: slskdn-wrapper

# Build configuration
build-options:
  cflags: -O2 -g
  cxxflags: -O2 -g
  env:
    - V=1

# Runtime requirements
finish-args:
  # Network access for Soulseek, mesh networking, and web features
  - --share=network
  # File system access for downloads and shares
  - --filesystem=xdg-download
  - --filesystem=xdg-documents
  - --filesystem=xdg-music
  - --filesystem=xdg-videos
  - --filesystem=xdg-pictures
  - --filesystem=~/.slskdn:create
  - --filesystem=~/.config/slskdn:create
  - --filesystem=~/.cache/slskdn:create
  # System integration
  - --device=dri
  - --socket=x11
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  # Portal access for file dialogs and notifications
  - --talk-name=org.freedesktop.portal.*
  - --talk-name=org.freedesktop.Notifications
  # Allow Tor/I2P connectivity for privacy features
  - --talk-name=org.freedesktop.Avahi


# Modules to build
modules:
  # .NET runtime (8.0 for slskdN)
  - name: dotnet
    buildsystem: simple
    build-commands:
      - |
        mkdir -p /app/dotnet
        # Download and install .NET 8.0 runtime
        curl -L https://download.visualstudio.microsoft.com/download/pr/8e3e4e7a-7c5f-4b7e-9b9d-4b2b9c5e8d8c/dotnet-runtime-8.0.0-linux-x64.tar.gz | tar -xz -C /app/dotnet
        ln -s /app/dotnet/dotnet /app/bin/dotnet
    sources:
      - type: archive
        url: https://download.visualstudio.microsoft.com/download/pr/dotnet-runtime-8.0.0-linux-x64.tar.gz
        sha256: PLACEHOLDER_SHA256_UPDATE_BEFORE_SUBMISSION

  # slskdN application
  - name: slskdn
    buildsystem: simple
    build-commands:
      - |
        # Create directories
        mkdir -p /app/bin
        mkdir -p /app/lib/slskdn
        mkdir -p /app/share/applications
        mkdir -p /app/share/icons/hicolor/512x512/apps
        mkdir -p /app/share/metainfo

        # Install slskdN binary
        cp slskd /app/lib/slskdn/
        chmod +x /app/lib/slskdn/slskd

        # Create wrapper script
        cat > /app/bin/slskdn-wrapper << 'EOF'
        #!/bin/bash
        set -e

        # Set up directories
        export SLSKD_CONFIG="${XDG_CONFIG_HOME:-$HOME/.config}/slskdn/slskd.yml"
        export SLSKD_SHARED_DIR="${XDG_DOCUMENTS_DIR:-$HOME/Documents}/slskdn/shared"
        export SLSKD_DOWNLOADS_DIR="${XDG_DOWNLOAD_DIR:-$HOME/Downloads}/slskdn"
        export SLSKD_INCOMPLETE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/slskdn/incomplete"

        # Create directories if they don't exist
        mkdir -p "$(dirname "$SLSKD_CONFIG")"
        mkdir -p "$SLSKD_SHARED_DIR"
        mkdir -p "$SLSKD_DOWNLOADS_DIR"
        mkdir -p "$SLSKD_INCOMPLETE_DIR"

        # Generate default config if it doesn't exist
        if [ ! -f "$SLSKD_CONFIG" ]; then
            cat > "$SLSKD_CONFIG" << 'DEFAULT_CONFIG'
        # slskdN Configuration (Generated by Flatpak)
        web:
          enabled: true
          port: 5030
          https:
            disabled: true

        soulseek:
          listen:
            port: 2234

        directories:
          shared: "~/Documents/slskdn/shared"
          downloads: "~/Downloads/slskdn"
          incomplete: "~/.cache/slskdn/incomplete"

        logger:
          level: info

        # VPN & Mesh Networking Features (Optional)
        # podcore:
        #   enabled: false
        #   peerId: ""  # Auto-generated

        # mesh:
        #   enabled: false
        #   networkName: ""
        #   networkPassword: ""
        #   peerId: ""

        # transports:
        #   tor:
        #     enabled: false
        #   i2p:
        #     enabled: false
        #   relay:
        #     enabled: false

        # privacy:
        #   enabled: false
        #   messagePadding: false
        #   timingObfuscation: false
        #   messageBatching: false

        # Note: Configure username/password through web UI after first run
        DEFAULT_CONFIG
        fi

        # Launch slskdN
        exec /app/dotnet/dotnet /app/lib/slskdn/slskd.dll "$@"
        EOF

        chmod +x /app/bin/slskdn-wrapper

        # Install desktop file
        cp slskdn.desktop /app/share/applications/
        cp slskdn.metainfo.xml /app/share/metainfo/

        # Install icon
        cp slskdn.png /app/share/icons/hicolor/512x512/apps/

    sources:
      # slskdN binary (will be downloaded from releases)
      # NOTE: Update URL and SHA256 before Flathub submission
      - type: archive
        url: https://github.com/slskd/slskd/releases/download/v0.1.0/slskdn-0.1.0-linux-x64.tar.gz
        sha256: PLACEHOLDER_SHA256_UPDATE_WITH_REAL_RELEASE

      # Desktop file
      - type: file
        path: slskdn.desktop

      # App metadata
      - type: file
        path: slskdn.metainfo.xml

      # Icon
      - type: file
        path: slskdn.png
